{
  "version": 3,
  "sources": ["../../server/logging/setupPageVisitAnalytics.ts"],
  "sourcesContent": ["import { NextFunction, Request, Response } from 'express';\nimport onFinished from 'on-finished';\n\nimport { logPageVisit } from '../services/analyticsService';\n\nconst EXCLUDED_PATHS = ['/health', '/ping', '/manifest.json' ];\n\nconst EXCLUDED_PATTERNS = [\n  /^\\/assets/,\n  /^\\/images/,\n  /^\\/js/,\n  /^\\/fonts/,\n  /^\\/css/,\n  /^\\/rebrand/,\n  /^\\/download/\n];\n\n\n/**\n * Middleware to set up page visit analytics logging.\n */\nconst setupPageVisitAnalytics = () => {\n  return (req: Request, res: Response, next: NextFunction) => {\n    onFinished(res, () => {\n      const { method, path } = req;\n      const { statusCode: responseStatusCode } = res;\n\n      if (method !== 'GET' || responseStatusCode >= 400 ) {\n        return;\n      }\n\n      if (EXCLUDED_PATHS.includes(path)) {\n        return;\n      }\n\n      if (EXCLUDED_PATTERNS.some(pattern => pattern.test(path))) {\n        return;\n      }\n\n      logPageVisit(req, res);\n    });\n\n    next();\n  };\n};\n\nexport default setupPageVisitAnalytics;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,yBAAuB;AAEvB,8BAA6B;AAE7B,MAAM,iBAAiB,CAAC,WAAW,SAAS,gBAAiB;AAE7D,MAAM,oBAAoB;AAAA,EACxB;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AAAA,EACA;AACF;AAMA,MAAM,0BAA0B,MAAM;AACpC,SAAO,CAAC,KAAc,KAAe,SAAuB;AAC1D,2BAAAA,SAAW,KAAK,MAAM;AACpB,YAAM,EAAE,QAAQ,KAAK,IAAI;AACzB,YAAM,EAAE,YAAY,mBAAmB,IAAI;AAE3C,UAAI,WAAW,SAAS,sBAAsB,KAAM;AAClD;AAAA,MACF;AAEA,UAAI,eAAe,SAAS,IAAI,GAAG;AACjC;AAAA,MACF;AAEA,UAAI,kBAAkB,KAAK,aAAW,QAAQ,KAAK,IAAI,CAAC,GAAG;AACzD;AAAA,MACF;AAEA,gDAAa,KAAK,GAAG;AAAA,IACvB,CAAC;AAED,SAAK;AAAA,EACP;AACF;AAEA,IAAO,kCAAQ;",
  "names": ["onFinished"]
}
