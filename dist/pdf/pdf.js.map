{
  "version": 3,
  "sources": ["../../server/pdf/pdf.ts"],
  "sourcesContent": ["import fs from 'fs';\n\nimport { Request } from 'express';\nimport { jsPDF } from 'jspdf';\n\nimport {Paragraph, Text} from '../@types/pdf';\nimport {\n  FONT,\n  FOOTER_HEIGHT,\n  HEADER_HEIGHT,\n  LINE_HEIGHT_RATIO,\n  MAIN_TEXT_SIZE,\n  MARGIN_WIDTH,\n  MM_PER_POINT,\n  SECTION_HEADING_SIZE,\n} from '../constants/pdfConstants';\nimport logger from '../logging/logger';\nimport getAssetPath from '../utils/getAssetPath';\n\nimport FontStyles from './fontStyles';\n\nclass Pdf {\n  public readonly document: jsPDF;\n  public readonly request: Request;\n  public readonly maxPageWidth: number;\n\n  public currentY = HEADER_HEIGHT;\n\n  private readonly logoData = `data:image/png;base64,${fs.readFileSync(getAssetPath('images/crest.png'), { encoding: 'base64' })}`;\n\n  constructor(autoPrint: boolean, request: Request) {\n    this.request = request;\n    // @ts-expect-error There is an error into the jsPDF type declaration.\n    this.document = new jsPDF({ lineHeight: LINE_HEIGHT_RATIO });\n    this.document.allowFsRead = [getAssetPath(\"fonts/\") + \"*\"];\n    this.maxPageWidth = this.document.internal.pageSize.getWidth() - 2 * MARGIN_WIDTH;\n    this.setupFonts();\n    // Set document title for proper filename when printing/downloading\n    this.document.setProperties({\n      title: request.__('pdf.name'),\n    });\n    if (autoPrint) this.document.autoPrint();\n    this.addHeaderToPage();\n  }\n\n  public toArrayBuffer() {\n    return this.document.output('arraybuffer');\n  }\n\n  public addFooterToEveryPage() {\n    for (let pageNumber = 1; pageNumber <= this.document.getNumberOfPages(); pageNumber++) {\n      this.document.setPage(pageNumber);\n      this.addFooterToPage(pageNumber);\n    }\n  }\n\n  private setupFonts() {\n    this.document.addFileToVFS(\n      'bold-b542beb274-v2.ttf',\n      fs.readFileSync(getAssetPath('fonts/bold-b542beb274-v2.ttf')).toString('base64'),\n    );\n    this.document.addFont('bold-b542beb274-v2.ttf', FONT, FontStyles.BOLD);\n    this.document.addFileToVFS(\n      'light-94a07e06a1-v2.ttf',\n      fs.readFileSync(getAssetPath('fonts/light-94a07e06a1-v2.ttf')).toString('base64'),\n    );\n    this.document.addFont('light-94a07e06a1-v2.ttf', FONT, FontStyles.NORMAL);\n  }\n\n  private addHeaderToPage() {\n    this.document.setFillColor(29, 112, 184).rect(0, 0, this.document.internal.pageSize.getWidth(), HEADER_HEIGHT, 'F');\n    const logoHeight = 8;\n    const logoWidth = logoHeight * 5;\n    this.document.addImage(\n      this.logoData,\n      'PNG',\n      MARGIN_WIDTH,\n      0.5 * (HEADER_HEIGHT - logoHeight),\n      logoWidth,\n      logoHeight,\n    );\n    this.document\n      .setFont(FONT, FontStyles.BOLD)\n      .setFontSize(SECTION_HEADING_SIZE)\n      .setTextColor(255, 255, 255)\n      .text(\n        this.request.__('pdf.name'),\n        logoWidth +\n          MARGIN_WIDTH +\n          0.5 * (this.document.internal.pageSize.getWidth() - logoWidth - MARGIN_WIDTH),\n        HEADER_HEIGHT * 0.5 + 0.25 * LINE_HEIGHT_RATIO * SECTION_HEADING_SIZE * MM_PER_POINT,\n        { align: 'center' },\n      )\n      .setTextColor(0, 0, 0);\n  }\n\n  private addFooterToPage(pageNumber: number) {\n    const pageCountText = this.request.__('pdf.pageCount', {\n      currentPage: pageNumber.toString(),\n      totalPages: this.document.getNumberOfPages().toString(),\n    });\n\n    const extraFooterText = this.request.__('pdf.everyPageReminder') || '';\n\n    const pageWidth = this.document.internal.pageSize.getWidth();\n    const pageHeight = this.document.internal.pageSize.getHeight();\n    const footerY = pageHeight - MARGIN_WIDTH;\n\n    // Draw centered, bold extra text if present\n    if (extraFooterText) {\n      this.document.setFont(FONT, FontStyles.BOLD).setFontSize(MAIN_TEXT_SIZE).text(extraFooterText, pageWidth / 2, footerY, { align: 'center' });\n    }\n\n    // Draw right-aligned page count on the same baseline (normal weight)\n    this.document\n      .setFont(FONT, FontStyles.NORMAL)\n      .setFontSize(MAIN_TEXT_SIZE)\n      .text(pageCountText, pageWidth - MARGIN_WIDTH, footerY, { align: 'right' });\n  }\n\n  heightWillOverflowDocument(height: number) {\n    return height + this.currentY > this.document.internal.pageSize.getHeight() - FOOTER_HEIGHT;\n  }\n\n  createNewPage() {\n    this.document.addPage();\n    this.currentY = HEADER_HEIGHT;\n    this.addHeaderToPage();\n  }\n\n  drawBorder(x: number, y: number, xSize: number, ySize: number) {\n    this.document.setDrawColor('black');\n    this.document.setLineWidth(0.5);\n    this.document.rect(x - 0.3, y - 0.3, xSize + 0.6, ySize + 0.6);\n  }\n\n  splitParagraph({ text, size, style }: Text): string[] {\n    this.document.setFontSize(size).setFont(FONT, style);\n    return this.document.splitTextToSize(text, this.maxPageWidth);\n  }\n\n  getParagraphHeight({ text, size, style, bottomPadding }: Paragraph) {\n    this.document.setFontSize(size).setFont(FONT, style);\n    const textLines = this.splitParagraph({ text, size, style });\n    return size * LINE_HEIGHT_RATIO * textLines.length * MM_PER_POINT + bottomPadding;\n  }\n\n  getTextWidth({ text, size, style }: Text) {\n    this.document.setFontSize(size).setFont(FONT, style);\n    return this.document.getTextWidth(text);\n  }\n\n  addText({\n    text,\n    x,\n    y,\n    size,\n    style,\n  }: {\n    text: string | string[];\n    x: number;\n    y: number;\n    size: number;\n    style: FontStyles;\n  }) {\n    this.document.setFontSize(size).setFont(FONT, style).text(text, x, y);\n  }\n\n  private addUrlizedParagraph(\n    {\n      text,\n      size,\n      style,\n    }: {\n      text: string[];\n      size: number;\n      style: FontStyles;\n    },\n    urls: string[],\n  ) {\n    this.document.setFontSize(size).setFont(FONT, style);\n\n    let startedUrl: string;\n\n    text.forEach((line) => {\n      this.currentY += size * LINE_HEIGHT_RATIO * MM_PER_POINT;\n      let currentX = MARGIN_WIDTH;\n\n      line\n        .trim()\n        .split(/(\\s+)/)\n        .forEach((word) => {\n          const nextUrl = urls[0];\n\n          const matches = RegExp(/^(\\(|<|&lt;)?(.*?)(\\.|,|\\)|\\n|&gt;)?$/).exec(word);\n\n          const leadingPunctuation = matches[1] || '';\n          const wordWithoutPunctuation = matches[2];\n          const trailingPunctuation = matches[3] || '';\n\n          if (leadingPunctuation) {\n            this.document.text(leadingPunctuation, currentX, this.currentY);\n            currentX += this.getTextWidth({ text: leadingPunctuation, size, style });\n          }\n\n          if (nextUrl?.startsWith(wordWithoutPunctuation) || startedUrl?.endsWith(wordWithoutPunctuation)) {\n            startedUrl = nextUrl;\n            this.document.textWithLink(wordWithoutPunctuation, currentX, this.currentY, { url: nextUrl });\n          } else {\n            this.document.text(wordWithoutPunctuation, currentX, this.currentY);\n          }\n          currentX += this.getTextWidth({ text: wordWithoutPunctuation, size, style });\n\n          if (startedUrl?.endsWith(wordWithoutPunctuation)) {\n            startedUrl = undefined;\n            urls.shift();\n          }\n\n          if (trailingPunctuation) {\n            this.document.text(trailingPunctuation, currentX, this.currentY);\n            currentX += this.getTextWidth({ text: trailingPunctuation, size, style });\n          }\n        });\n    });\n  }\n\n  addParagraph({ text, size, style, bottomPadding, urlize }: Paragraph) {\n    // The first line of text goes above the current y value, so add a single line of spacing to make the paragraph\n    // behave the same as all other components we add\n    const textLines = this.splitParagraph({ text, size, style });\n    if (urlize) {\n      const urls = (text.match(/https?:\\/\\/\\S+/g) || []).map((url) => url.replace(/^[(|<|&lt;]+|[.|,|)|\\n|&gt;]+$/g, ''));\n      this.addUrlizedParagraph({ text: textLines, size, style }, urls);\n\n      if (urls.length !== 0) {\n        logger.error('URL was not linked in PDF. URL missed: ' + urls);\n      }\n    } else {\n      this.currentY += size * LINE_HEIGHT_RATIO * MM_PER_POINT;\n      this.addText({ text: textLines, x: MARGIN_WIDTH, y: this.currentY, size, style });\n      this.currentY += size * LINE_HEIGHT_RATIO * (textLines.length - 1) * MM_PER_POINT;\n    }\n\n    this.currentY += bottomPadding;\n  }\n}\n\nexport default Pdf;\n"],
  "mappings": "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",
  "names": ["fs", "getAssetPath", "FontStyles", "logger"]
}
