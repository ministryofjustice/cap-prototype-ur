{
  "version": 3,
  "sources": ["../../server/middleware/setUpWebSecurity.ts"],
  "sourcesContent": ["import crypto from 'crypto';\n\nimport { Router, Request, Response, NextFunction } from 'express';\nimport helmet from 'helmet';\n\nimport config from '../config';\n\nconst setUpWebSecurity = (): Router => {\n  const router = Router();\n\n  // Secure code best practice - see:\n  // 1. https://expressjs.com/en/advanced/best-practice-security.html,\n  // 2. https://www.npmjs.com/package/helmet\n  router.use((_req: Request, response: Response, next: NextFunction) => {\n    response.locals.cspNonce = crypto.randomBytes(16).toString('hex');\n    next();\n  });\n  router.use(\n    helmet({\n      contentSecurityPolicy: {\n        directives: {\n          defaultSrc: [\"'self'\"],\n          // This nonce allows us to use scripts with the use of the `cspNonce` local, e.g (in a Nunjucks template):\n          // <script nonce=\"{{ cspNonce }}\">\n          // or\n          // <link href=\"http://example.com/\" rel=\"stylesheet\" nonce=\"{{ cspNonce }}\">\n          // This ensures only scripts we trust are loaded, and not anything injected into the\n          // page by an attacker.\n          scriptSrc: [\n            \"'self'\",\n            (_request: Request, reponse: Response) => `'nonce-${reponse.locals.cspNonce}'`,\n            'https://*.googletagmanager.com',\n          ],\n          imgSrc: [\"'self'\", 'data:', 'https://*.google-analytics.com', 'https://*.googletagmanager.com'],\n          connectSrc: [\n            \"'self'\",\n            'https://*.google-analytics.com',\n            'https://*.analytics.google.com',\n            'https://*.googletagmanager.com',\n          ],\n          styleSrc: [\"'self'\", (_req: Request, response: Response) => `'nonce-${response.locals.cspNonce}'`],\n          fontSrc: [\"'self'\"],\n          formAction: [\"'self'\"],\n          upgradeInsecureRequests: config.useHttps ? [] : null,\n        },\n      },\n      crossOriginEmbedderPolicy: true,\n      strictTransportSecurity: config.useHttps,\n    }),\n  );\n  return router;\n};\n\nexport default setUpWebSecurity;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,oBAAmB;AAEnB,qBAAwD;AACxD,oBAAmB;AAEnB,oBAAmB;AAEnB,MAAM,mBAAmB,MAAc;AACrC,QAAM,aAAS,uBAAO;AAKtB,SAAO,IAAI,CAAC,MAAe,UAAoB,SAAuB;AACpE,aAAS,OAAO,WAAW,cAAAA,QAAO,YAAY,EAAE,EAAE,SAAS,KAAK;AAChE,SAAK;AAAA,EACP,CAAC;AACD,SAAO;AAAA,QACL,cAAAC,SAAO;AAAA,MACL,uBAAuB;AAAA,QACrB,YAAY;AAAA,UACV,YAAY,CAAC,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,UAOrB,WAAW;AAAA,YACT;AAAA,YACA,CAAC,UAAmB,YAAsB,UAAU,QAAQ,OAAO,QAAQ;AAAA,YAC3E;AAAA,UACF;AAAA,UACA,QAAQ,CAAC,UAAU,SAAS,kCAAkC,gCAAgC;AAAA,UAC9F,YAAY;AAAA,YACV;AAAA,YACA;AAAA,YACA;AAAA,YACA;AAAA,UACF;AAAA,UACA,UAAU,CAAC,UAAU,CAAC,MAAe,aAAuB,UAAU,SAAS,OAAO,QAAQ,GAAG;AAAA,UACjG,SAAS,CAAC,QAAQ;AAAA,UAClB,YAAY,CAAC,QAAQ;AAAA,UACrB,yBAAyB,cAAAC,QAAO,WAAW,CAAC,IAAI;AAAA,QAClD;AAAA,MACF;AAAA,MACA,2BAA2B;AAAA,MAC3B,yBAAyB,cAAAA,QAAO;AAAA,IAClC,CAAC;AAAA,EACH;AACA,SAAO;AACT;AAEA,IAAO,2BAAQ;",
  "names": ["crypto", "helmet", "config"]
}
