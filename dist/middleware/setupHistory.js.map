{
  "version": 3,
  "sources": ["../../server/middleware/setupHistory.ts"],
  "sourcesContent": ["import { Router } from 'express';\n\nimport paths from '../constants/paths';\n\nconst pathsNotForHistory = [\n  // These pdf pages should not be in the history, as they are not navigated to\n  paths.DOWNLOAD_PDF,\n  paths.PRINT_PDF,\n  paths.DOWNLOAD_PAPER_FORM,\n  // These pages should be skipped in the back button\n  paths.PASSWORD,\n  paths.ACCESSIBILITY_STATEMENT,\n  paths.CONTACT_US,\n  paths.COOKIES,\n  paths.PRIVACY_NOTICE,\n  paths.TERMS_AND_CONDITIONS,\n  paths.EXISTING_COURT_ORDER,\n];\nconst pathsForHistory = Object.values(paths).filter((path) => !pathsNotForHistory.includes(path));\n\nconst setupHistory = (): Router => {\n  const router = Router();\n\n  router.get('*', (request, response, next) => {\n    const requestUrl = request.originalUrl;\n    const isTrackedPath = pathsForHistory.includes(requestUrl as paths);\n\n    // Only update history after response is sent and only if it was successful (200)\n    response.on('finish', () => {\n      const history = request.session.pageHistory || [paths.START];\n      const lastPage = history[history.length - 1];\n      const secondLastPage = history[history.length - 2];\n\n      // For error pages (404, 500) and redirects (302), don't add to history but still set previousPage\n      if (response.statusCode !== 200) {\n        if (lastPage && lastPage !== requestUrl) {\n          request.session.previousPage = lastPage;\n        }\n        return;\n      }\n\n      // Special case: task list resets history\n      if (requestUrl === paths.TASK_LIST) {\n        request.session.pageHistory = [requestUrl];\n        request.session.previousPage = undefined;\n        return;\n      }\n\n      if (isTrackedPath) {\n        request.session.pageHistory = history;\n\n        // Going back in the history\n        if (secondLastPage === requestUrl) {\n          history.pop();\n        } else if (lastPage !== requestUrl) {\n          history.push(requestUrl);\n\n          // Limit history to 20 pages\n          if (history.length >= 20) {\n            history.shift();\n          }\n        }\n\n        const previousPage = history[history.length - 2];\n        request.session.previousPage = previousPage && previousPage !== requestUrl ? previousPage : undefined;\n      } else {\n        // For non-tracked paths, set previousPage to last tracked page\n        if (lastPage && lastPage !== requestUrl) {\n          request.session.previousPage = lastPage;\n        }\n      }\n    });\n\n    next();\n  });\n  return router;\n};\n\nexport default setupHistory;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAAuB;AAEvB,mBAAkB;AAElB,MAAM,qBAAqB;AAAA;AAAA,EAEzB,aAAAA,QAAM;AAAA,EACN,aAAAA,QAAM;AAAA,EACN,aAAAA,QAAM;AAAA;AAAA,EAEN,aAAAA,QAAM;AAAA,EACN,aAAAA,QAAM;AAAA,EACN,aAAAA,QAAM;AAAA,EACN,aAAAA,QAAM;AAAA,EACN,aAAAA,QAAM;AAAA,EACN,aAAAA,QAAM;AAAA,EACN,aAAAA,QAAM;AACR;AACA,MAAM,kBAAkB,OAAO,OAAO,aAAAA,OAAK,EAAE,OAAO,CAAC,SAAS,CAAC,mBAAmB,SAAS,IAAI,CAAC;AAEhG,MAAM,eAAe,MAAc;AACjC,QAAM,aAAS,uBAAO;AAEtB,SAAO,IAAI,KAAK,CAAC,SAAS,UAAU,SAAS;AAC3C,UAAM,aAAa,QAAQ;AAC3B,UAAM,gBAAgB,gBAAgB,SAAS,UAAmB;AAGlE,aAAS,GAAG,UAAU,MAAM;AAC1B,YAAM,UAAU,QAAQ,QAAQ,eAAe,CAAC,aAAAA,QAAM,KAAK;AAC3D,YAAM,WAAW,QAAQ,QAAQ,SAAS,CAAC;AAC3C,YAAM,iBAAiB,QAAQ,QAAQ,SAAS,CAAC;AAGjD,UAAI,SAAS,eAAe,KAAK;AAC/B,YAAI,YAAY,aAAa,YAAY;AACvC,kBAAQ,QAAQ,eAAe;AAAA,QACjC;AACA;AAAA,MACF;AAGA,UAAI,eAAe,aAAAA,QAAM,WAAW;AAClC,gBAAQ,QAAQ,cAAc,CAAC,UAAU;AACzC,gBAAQ,QAAQ,eAAe;AAC/B;AAAA,MACF;AAEA,UAAI,eAAe;AACjB,gBAAQ,QAAQ,cAAc;AAG9B,YAAI,mBAAmB,YAAY;AACjC,kBAAQ,IAAI;AAAA,QACd,WAAW,aAAa,YAAY;AAClC,kBAAQ,KAAK,UAAU;AAGvB,cAAI,QAAQ,UAAU,IAAI;AACxB,oBAAQ,MAAM;AAAA,UAChB;AAAA,QACF;AAEA,cAAM,eAAe,QAAQ,QAAQ,SAAS,CAAC;AAC/C,gBAAQ,QAAQ,eAAe,gBAAgB,iBAAiB,aAAa,eAAe;AAAA,MAC9F,OAAO;AAEL,YAAI,YAAY,aAAa,YAAY;AACvC,kBAAQ,QAAQ,eAAe;AAAA,QACjC;AAAA,MACF;AAAA,IACF,CAAC;AAED,SAAK;AAAA,EACP,CAAC;AACD,SAAO;AACT;AAEA,IAAO,uBAAQ;",
  "names": ["paths"]
}
