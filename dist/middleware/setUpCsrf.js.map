{
  "version": 3,
  "sources": ["../../server/middleware/setUpCsrf.ts"],
  "sourcesContent": ["import { csrfSync } from 'csrf-sync';\nimport { Router } from 'express';\n\nconst testMode = process.env.NODE_ENV === 'test';\n\nconst setUpCsrf = (): Router => {\n  const router = Router({ mergeParams: true });\n\n  // CSRF protection\n  if (!testMode) {\n    const {\n      csrfSynchronisedProtection, // This is the default CSRF protection middleware.\n    } = csrfSync({\n      // By default, csrf-sync uses x-csrf-token header, but we use the token in forms and send it in the request body, so change getTokenFromRequest so it grabs from there\n      getTokenFromRequest: (req) => {\n        return req.body._csrf;\n      },\n    });\n\n    // Apply CSRF protection but skip for analytics endpoints (they use sendBeacon during page unload)\n    router.use((req, res, next) => {\n      if (req.path.startsWith('/api/analytics/')) {\n        return next();\n      }\n      return csrfSynchronisedProtection(req, res, next);\n    });\n  }\n\n  router.use((request, response, next) => {\n    if (typeof request.csrfToken === 'function') {\n      response.locals.csrfToken = request.csrfToken();\n    }\n    next();\n  });\n\n  return router;\n};\n\nexport default setUpCsrf;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,uBAAyB;AACzB,qBAAuB;AAEvB,MAAM,WAAW,QAAQ,IAAI,aAAa;AAE1C,MAAM,YAAY,MAAc;AAC9B,QAAM,aAAS,uBAAO,EAAE,aAAa,KAAK,CAAC;AAG3C,MAAI,CAAC,UAAU;AACb,UAAM;AAAA,MACJ;AAAA;AAAA,IACF,QAAI,2BAAS;AAAA;AAAA,MAEX,qBAAqB,CAAC,QAAQ;AAC5B,eAAO,IAAI,KAAK;AAAA,MAClB;AAAA,IACF,CAAC;AAGD,WAAO,IAAI,CAAC,KAAK,KAAK,SAAS;AAC7B,UAAI,IAAI,KAAK,WAAW,iBAAiB,GAAG;AAC1C,eAAO,KAAK;AAAA,MACd;AACA,aAAO,2BAA2B,KAAK,KAAK,IAAI;AAAA,IAClD,CAAC;AAAA,EACH;AAEA,SAAO,IAAI,CAAC,SAAS,UAAU,SAAS;AACtC,QAAI,OAAO,QAAQ,cAAc,YAAY;AAC3C,eAAS,OAAO,YAAY,QAAQ,UAAU;AAAA,IAChD;AACA,SAAK;AAAA,EACP,CAAC;AAED,SAAO;AACT;AAEA,IAAO,oBAAQ;",
  "names": []
}
