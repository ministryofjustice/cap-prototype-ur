{
  "version": 3,
  "sources": ["../../server/middleware/setupRateLimit.ts"],
  "sourcesContent": ["import { Router } from 'express';\nimport rateLimit from 'express-rate-limit';\nimport type { Request, Response } from 'express-serve-static-core';\n\nimport config from '../config';\nimport createRedisStore from '../utils/redisStoreFactory';\n\nconst setupRateLimit = () => {\n  const router = Router();\n\n  const isTestEnvironment = process.env.NODE_ENV === 'test';\n\n  const rateLimitHandler = (request: Request, response: Response) => {\n    const { production } = config;\n    response.status(429).render('pages/errors/rateLimit', {\n      production: config.production,\n      title: production ? request.__('errors.rateLimit.title') : 'Too many requests',\n    });\n  };\n\n  const generalLimiter = rateLimit({\n    windowMs: 15 * 60 * 1000, // 15 minutes\n    max: isTestEnvironment ? 15000 : 250, // Much higher limit for tests to avoid false failures\n    standardHeaders: true, // Return rate limit info in the `RateLimit-*` headers\n    legacyHeaders: false, // Disable the `X-RateLimit-*` headers\n    validate: { trustProxy: true },\n    keyGenerator: (req: Request) => {\n      return req.ip || 'unknown';\n    },\n    store: createRedisStore('general:'),\n    skip: (req: Request) => {\n      return '/health' === req.path || req.path.startsWith('/assets');\n    },\n    handler: rateLimitHandler,\n  });\n\n  // download/PDF generation endpoints (resource-intensive)\n  const downloadLimiter = rateLimit({\n    windowMs: 15 * 60 * 1000,// 15 minutes\n    max: isTestEnvironment ? 1000 : 20,// Higher limit for tests\n    standardHeaders: true,\n    legacyHeaders: false,\n    validate: { trustProxy: true },\n    keyGenerator: (req: Request) => {\n      return req.ip || 'unknown';\n    },\n    store: createRedisStore('download:'),\n    handler: rateLimitHandler,\n    skipSuccessfulRequests: false, // Count all requests, even successful ones\n  });\n\n  const authLimiter = rateLimit({\n    windowMs: 15 * 60 * 1000,\n    max: isTestEnvironment ? 1000 : 10, // Higher limit for tests\n    standardHeaders: true,\n    legacyHeaders: false,\n    validate: { trustProxy: true},\n    keyGenerator: (req: Request) => {\n      return req.ip || 'unknown';\n    },\n    store: createRedisStore('auth:'),\n    handler: rateLimitHandler,\n    skipSuccessfulRequests: true, // Only count failed requests\n  });\n\n  // Apply specific limiters first (more specific routes)\n  router.use('/download-pdf', downloadLimiter);\n  router.use('/download-html', downloadLimiter);\n  router.use('/print-pdf', downloadLimiter);\n  router.use('/download-paper-form', downloadLimiter);\n  router.use('/password', authLimiter);\n\n  // Apply general limiter to all other routes\n  router.use(generalLimiter);\n\n  return router;\n};\n\nexport default setupRateLimit;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,qBAAuB;AACvB,gCAAsB;AAGtB,oBAAmB;AACnB,+BAA6B;AAE7B,MAAM,iBAAiB,MAAM;AAC3B,QAAM,aAAS,uBAAO;AAEtB,QAAM,oBAAoB,QAAQ,IAAI,aAAa;AAEnD,QAAM,mBAAmB,CAAC,SAAkB,aAAuB;AACjE,UAAM,EAAE,WAAW,IAAI,cAAAA;AACvB,aAAS,OAAO,GAAG,EAAE,OAAO,0BAA0B;AAAA,MACpD,YAAY,cAAAA,QAAO;AAAA,MACnB,OAAO,aAAa,QAAQ,GAAG,wBAAwB,IAAI;AAAA,IAC7D,CAAC;AAAA,EACH;AAEA,QAAM,qBAAiB,0BAAAC,SAAU;AAAA,IAC/B,UAAU,KAAK,KAAK;AAAA;AAAA,IACpB,KAAK,oBAAoB,OAAQ;AAAA;AAAA,IACjC,iBAAiB;AAAA;AAAA,IACjB,eAAe;AAAA;AAAA,IACf,UAAU,EAAE,YAAY,KAAK;AAAA,IAC7B,cAAc,CAAC,QAAiB;AAC9B,aAAO,IAAI,MAAM;AAAA,IACnB;AAAA,IACA,WAAO,yBAAAC,SAAiB,UAAU;AAAA,IAClC,MAAM,CAAC,QAAiB;AACtB,aAAO,cAAc,IAAI,QAAQ,IAAI,KAAK,WAAW,SAAS;AAAA,IAChE;AAAA,IACA,SAAS;AAAA,EACX,CAAC;AAGD,QAAM,sBAAkB,0BAAAD,SAAU;AAAA,IAChC,UAAU,KAAK,KAAK;AAAA;AAAA,IACpB,KAAK,oBAAoB,MAAO;AAAA;AAAA,IAChC,iBAAiB;AAAA,IACjB,eAAe;AAAA,IACf,UAAU,EAAE,YAAY,KAAK;AAAA,IAC7B,cAAc,CAAC,QAAiB;AAC9B,aAAO,IAAI,MAAM;AAAA,IACnB;AAAA,IACA,WAAO,yBAAAC,SAAiB,WAAW;AAAA,IACnC,SAAS;AAAA,IACT,wBAAwB;AAAA;AAAA,EAC1B,CAAC;AAED,QAAM,kBAAc,0BAAAD,SAAU;AAAA,IAC5B,UAAU,KAAK,KAAK;AAAA,IACpB,KAAK,oBAAoB,MAAO;AAAA;AAAA,IAChC,iBAAiB;AAAA,IACjB,eAAe;AAAA,IACf,UAAU,EAAE,YAAY,KAAI;AAAA,IAC5B,cAAc,CAAC,QAAiB;AAC9B,aAAO,IAAI,MAAM;AAAA,IACnB;AAAA,IACA,WAAO,yBAAAC,SAAiB,OAAO;AAAA,IAC/B,SAAS;AAAA,IACT,wBAAwB;AAAA;AAAA,EAC1B,CAAC;AAGD,SAAO,IAAI,iBAAiB,eAAe;AAC3C,SAAO,IAAI,kBAAkB,eAAe;AAC5C,SAAO,IAAI,cAAc,eAAe;AACxC,SAAO,IAAI,wBAAwB,eAAe;AAClD,SAAO,IAAI,aAAa,WAAW;AAGnC,SAAO,IAAI,cAAc;AAEzB,SAAO;AACT;AAEA,IAAO,yBAAQ;",
  "names": ["config", "rateLimit", "createRedisStore"]
}
