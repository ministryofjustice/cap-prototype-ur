{
  "version": 3,
  "sources": ["../../server/middleware/setUpWebSession.ts"],
  "sourcesContent": ["import flash from 'connect-flash';\nimport { RedisStore } from 'connect-redis';\nimport { Router } from 'express';\nimport session, { MemoryStore, Store } from 'express-session';\n\nimport config from '../config';\nimport cookieNames from '../constants/cookieNames';\nimport createCacheClient from '../data/cacheClient';\nimport logger from '../logging/logger';;\n\nconst setUpWebSession = (): Router => {\n  let store: Store;\n  if (config.cache.enabled) {\n    const client = createCacheClient();\n    client.connect().catch((err: Error) => logger.error(`Error connecting to cache`, err));\n    store = new RedisStore({ client });\n  } else {\n    store = new MemoryStore();\n  }\n\n  const router = Router();\n  router.use(\n    session({\n      store,\n      name: cookieNames.SESSION,\n      cookie: { secure: config.useHttps, sameSite: 'lax', maxAge: config.session.expiryMinutes * 60 * 1000 },\n      secret: config.session.secret,\n      resave: true, // Ensures session is saved on every request, preventing race conditions with Redis\n      saveUninitialized: false,\n      rolling: true,\n    }),\n  );\n\n  // Update a value in the cookie so that the set-cookie will be sent.\n  // Only changes every minute so that it's not sent with every request.\n  router.use((request, _, next) => {\n    request.session.nowInMinutes = Math.floor(Date.now() / 60e3);\n    next();\n  });\n\n  router.use(flash());\n\n  return router;\n};\n\nexport default setUpWebSession;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,2BAAkB;AAClB,2BAA2B;AAC3B,qBAAuB;AACvB,6BAA4C;AAE5C,oBAAmB;AACnB,yBAAwB;AACxB,yBAA8B;AAC9B,oBAAmB;AAAoB;AAEvC,MAAM,kBAAkB,MAAc;AACpC,MAAI;AACJ,MAAI,cAAAA,QAAO,MAAM,SAAS;AACxB,UAAM,aAAS,mBAAAC,SAAkB;AACjC,WAAO,QAAQ,EAAE,MAAM,CAAC,QAAe,cAAAC,QAAO,MAAM,6BAA6B,GAAG,CAAC;AACrF,YAAQ,IAAI,gCAAW,EAAE,OAAO,CAAC;AAAA,EACnC,OAAO;AACL,YAAQ,IAAI,mCAAY;AAAA,EAC1B;AAEA,QAAM,aAAS,uBAAO;AACtB,SAAO;AAAA,QACL,uBAAAC,SAAQ;AAAA,MACN;AAAA,MACA,MAAM,mBAAAC,QAAY;AAAA,MAClB,QAAQ,EAAE,QAAQ,cAAAJ,QAAO,UAAU,UAAU,OAAO,QAAQ,cAAAA,QAAO,QAAQ,gBAAgB,KAAK,IAAK;AAAA,MACrG,QAAQ,cAAAA,QAAO,QAAQ;AAAA,MACvB,QAAQ;AAAA;AAAA,MACR,mBAAmB;AAAA,MACnB,SAAS;AAAA,IACX,CAAC;AAAA,EACH;AAIA,SAAO,IAAI,CAAC,SAAS,GAAG,SAAS;AAC/B,YAAQ,QAAQ,eAAe,KAAK,MAAM,KAAK,IAAI,IAAI,GAAI;AAC3D,SAAK;AAAA,EACP,CAAC;AAED,SAAO,QAAI,qBAAAK,SAAM,CAAC;AAElB,SAAO;AACT;AAEA,IAAO,0BAAQ;",
  "names": ["config", "createCacheClient", "logger", "session", "cookieNames", "flash"]
}
