{
  "version": 3,
  "sources": ["../../server/middleware/checkFormProgressFromConfig.ts"],
  "sourcesContent": ["import { Request, Response, NextFunction } from 'express';\nimport createError from 'http-errors';\n\nimport { CAPSession } from '../@types/session';\nimport TASK_FLOW_MAP from '../config/flowConfig';\nimport logger from '../logging/logger';\nimport {\n  hasCompletedRequiredSteps,\n  hasUserStartedJourney,\n  getRedirectPath,\n  getFlashMessage,\n} from '../utils/formProgressHelpers';\n\ntype SessionRequest = Request & { session?: Partial<CAPSession> };\n\n/**\n * Middleware factory to check if the user has completed the prerequisites\n * defined in the `TASK_FLOW_MAP` for the given step key.\n *\n * Handles three scenarios:\n * 1. Fresh visitor (no journey started) \u2192 silent redirect to start\n * 2. POST failure (visited page but submission failed) \u2192 redirect with \"progress not saved\" message\n * 3. Jumping ahead (skipped required steps) \u2192 redirect with \"complete this page\" message\n *\n * @param currentStepKey - A key from TASK_FLOW_MAP (e.g. 'step3')\n */\nfunction checkFormProgressFromConfig(currentStepKey: keyof typeof TASK_FLOW_MAP) {\n  const startPage = TASK_FLOW_MAP.step1?.path ?? '/';\n  const stepConfig = TASK_FLOW_MAP[currentStepKey];\n\n  if (!stepConfig) {\n    logger.error(`ERROR: Step '${String(currentStepKey)}' not found in TASK_FLOW_MAP.`);\n    throw createError(404);\n  }\n\n  const requiredSteps = stepConfig.dependsOn || [];\n\n  return (req: SessionRequest, res: Response, next: NextFunction) => {\n    const completedSteps: string[] = req.session?.completedSteps || [];\n    const pageHistory: string[] = req.session?.pageHistory || [];\n\n    const hasRequired = hasCompletedRequiredSteps(completedSteps, requiredSteps);\n\n    if (hasRequired) {\n      return next();\n    }\n\n    // User hasn't met prerequisites - determine redirect strategy\n\n    // Check if user has even started the journey\n    if (!hasUserStartedJourney(completedSteps, pageHistory)) {\n      logger.info(\n        `Access denied to ${req.path} (${String(currentStepKey)}). User hasn't started journey. Redirecting to ${startPage}`\n      );\n      return res.redirect(startPage);\n    }\n\n    // User has started journey but is missing prerequisites\n    const missingSteps = requiredSteps.filter(step => !completedSteps.includes(step));\n    const redirectPath = getRedirectPath(missingSteps, startPage);\n    const hasVisitedRedirectPage = pageHistory.includes(redirectPath);\n\n    logger.info(\n      `Access denied to ${req.path} (${String(currentStepKey)}). ` +\n      `Missing steps: ${missingSteps.join(', ') || 'none (alternative path required)'}. ` +\n      `Redirecting to ${redirectPath}. Has visited before: ${hasVisitedRedirectPage}`\n    );\n\n    const flashMessage = getFlashMessage(hasVisitedRedirectPage);\n    req.flash('info', flashMessage);\n\n    return res.redirect(redirectPath);\n  };\n}\n\nexport default checkFormProgressFromConfig;"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,yBAAwB;AAGxB,wBAA0B;AAC1B,oBAAmB;AACnB,iCAKO;AAeP,SAAS,4BAA4B,gBAA4C;AAC/E,QAAM,YAAY,kBAAAA,QAAc,OAAO,QAAQ;AAC/C,QAAM,aAAa,kBAAAA,QAAc,cAAc;AAE/C,MAAI,CAAC,YAAY;AACf,kBAAAC,QAAO,MAAM,gBAAgB,OAAO,cAAc,CAAC,+BAA+B;AAClF,cAAM,mBAAAC,SAAY,GAAG;AAAA,EACvB;AAEA,QAAM,gBAAgB,WAAW,aAAa,CAAC;AAE/C,SAAO,CAAC,KAAqB,KAAe,SAAuB;AACjE,UAAM,iBAA2B,IAAI,SAAS,kBAAkB,CAAC;AACjE,UAAM,cAAwB,IAAI,SAAS,eAAe,CAAC;AAE3D,UAAM,kBAAc,sDAA0B,gBAAgB,aAAa;AAE3E,QAAI,aAAa;AACf,aAAO,KAAK;AAAA,IACd;AAKA,QAAI,KAAC,kDAAsB,gBAAgB,WAAW,GAAG;AACvD,oBAAAD,QAAO;AAAA,QACL,oBAAoB,IAAI,IAAI,KAAK,OAAO,cAAc,CAAC,kDAAkD,SAAS;AAAA,MACpH;AACA,aAAO,IAAI,SAAS,SAAS;AAAA,IAC/B;AAGA,UAAM,eAAe,cAAc,OAAO,UAAQ,CAAC,eAAe,SAAS,IAAI,CAAC;AAChF,UAAM,mBAAe,4CAAgB,cAAc,SAAS;AAC5D,UAAM,yBAAyB,YAAY,SAAS,YAAY;AAEhE,kBAAAA,QAAO;AAAA,MACL,oBAAoB,IAAI,IAAI,KAAK,OAAO,cAAc,CAAC,qBACrC,aAAa,KAAK,IAAI,KAAK,kCAAkC,oBAC7D,YAAY,yBAAyB,sBAAsB;AAAA,IAC/E;AAEA,UAAM,mBAAe,4CAAgB,sBAAsB;AAC3D,QAAI,MAAM,QAAQ,YAAY;AAE9B,WAAO,IAAI,SAAS,YAAY;AAAA,EAClC;AACF;AAEA,IAAO,sCAAQ;",
  "names": ["TASK_FLOW_MAP", "logger", "createError"]
}
