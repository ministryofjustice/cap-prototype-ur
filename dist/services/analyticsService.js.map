{
  "version": 3,
  "sources": ["../../server/services/analyticsService.ts"],
  "sourcesContent": ["import { Request, Response } from 'express';\n\nimport config from '../config';\nimport UserEvents from '../constants/userEvents';\nimport logger from '../logging/logger';\nimport { generateHashedIdentifier } from '../utils/hashedIdentifier';\n\n/**\n * A generic event logging function that forms the base for all analytics events.\n * @param eventType - The type of the event (e.g., 'page_visit').\n * @param data - An object containing event-specific data.\n */\nconst logEvent = (eventType: string, data: Record<string, string | number>) => {\n  // Skip logging if analytics is disabled at environment level\n  if (!config.analytics.enabled) {\n    return;\n  }\n\n  const logEntry = {\n    timestamp: new Date().toISOString(),\n    event_type: eventType,\n    ...data,\n  };\n  logger.info(logEntry, `${eventType} event`);\n};\n\n/**\n * Logs a 'page_visit' event.\n * This function is called by the structuredLogging middleware.\n */\nconst logPageVisit = (req: Request, res: Response) => {\n  const { method, path } = req;\n  const { statusCode } = res;\n\n  // Generate privacy-preserving hashed identifier\n  // This rotates every 24 hours for GDPR compliance while allowing deduplication\n  const hashedUserId = generateHashedIdentifier(req.ip, req.get('user-agent'));\n\n  const eventData = {\n    hashed_user_id: hashedUserId,\n    path: path,\n    method: method,\n    status_code: statusCode,\n  };\n\n  logEvent(UserEvents.PAGE_VISIT, eventData);\n};\n\n/**\n * Logs a 'download' event.\n * This function is called when a user downloads a PDF or HTML file.\n * @param req - Express request object\n * @param downloadType - Type of download (e.g., 'output_pdf', 'output_html', 'offline_pdf')\n */\nconst logDownload = (req: Request, downloadType: string) => {\n  // Generate privacy-preserving hashed identifier\n  const hashedUserId = generateHashedIdentifier(req.ip, req.get('user-agent'));\n\n  const eventData = {\n    hashed_user_id: hashedUserId,\n    download_type: downloadType,\n    path: req.path,\n  };\n\n  logEvent(UserEvents.DOWNLOAD, eventData);\n};\n\n/**\n * Logs a 'link_click' event.\n * This function is called when a user clicks a link (internal or external).\n * @param req - Express request object\n * @param linkUrl - The URL of the link that was clicked\n * @param linkText - Optional text/label of the link\n * @param linkType - Optional type of link (internal or external)\n * @param currentPage - Optional page path where the link was clicked\n */\nconst logLinkClick = (\n  req: Request,\n  linkUrl: string,\n  linkText?: string,\n  linkType?: string,\n  currentPage?: string,\n) => {\n  // Generate privacy-preserving hashed identifier\n  const hashedUserId = generateHashedIdentifier(req.ip, req.get('user-agent'));\n\n  const eventData: Record<string, string | number> = {\n    hashed_user_id: hashedUserId,\n    link_url: linkUrl,\n    page: currentPage || req.path,\n  };\n\n  if (linkText) {\n    eventData.link_text = linkText;\n  }\n\n  if (linkType) {\n    eventData.link_type = linkType;\n  }\n\n  logEvent(UserEvents.LINK_CLICK, eventData);\n};\n\n/**\n * Logs a 'page_exit' event.\n * This function is called when a user closes the browser window, tab, or navigates away.\n * @param req - Express request object\n * @param exitPage - The page path from which the user is exiting\n * @param destinationUrl - Optional destination URL if known\n */\nconst logPageExit = (req: Request, exitPage: string, destinationUrl?: string) => {\n  // Generate privacy-preserving hashed identifier\n  const hashedUserId = generateHashedIdentifier(req.ip, req.get('user-agent'));\n\n  const eventData: Record<string, string | number> = {\n    hashed_user_id: hashedUserId,\n    exit_page: exitPage,\n    path: req.path,\n  };\n\n  if (destinationUrl) {\n    eventData.destination_url = destinationUrl;\n  }\n\n  logEvent(UserEvents.PAGE_EXIT, eventData);\n};\n\n/**\n * Logs a 'quick_exit' event.\n * This function is called when a user presses the quick exit button or uses the keyboard shortcut.\n * @param req - Express request object\n * @param exitPage - The page path from which the user is exiting\n */\nconst logQuickExit = (req: Request, exitPage: string) => {\n  // Generate privacy-preserving hashed identifier\n  const hashedUserId = generateHashedIdentifier(req.ip, req.get('user-agent'));\n\n  const eventData = {\n    hashed_user_id: hashedUserId,\n    exit_page: exitPage,\n    path: req.path,\n  };\n\n  logEvent(UserEvents.QUICK_EXIT, eventData);\n};\n\nexport { logEvent, logPageVisit, logDownload, logLinkClick, logPageExit, logQuickExit };"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,oBAAmB;AACnB,wBAAuB;AACvB,oBAAmB;AACnB,8BAAyC;AAOzC,MAAM,WAAW,CAAC,WAAmB,SAA0C;AAE7E,MAAI,CAAC,cAAAA,QAAO,UAAU,SAAS;AAC7B;AAAA,EACF;AAEA,QAAM,WAAW;AAAA,IACf,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,IAClC,YAAY;AAAA,IACZ,GAAG;AAAA,EACL;AACA,gBAAAC,QAAO,KAAK,UAAU,GAAG,SAAS,QAAQ;AAC5C;AAMA,MAAM,eAAe,CAAC,KAAc,QAAkB;AACpD,QAAM,EAAE,QAAQ,KAAK,IAAI;AACzB,QAAM,EAAE,WAAW,IAAI;AAIvB,QAAM,mBAAe,kDAAyB,IAAI,IAAI,IAAI,IAAI,YAAY,CAAC;AAE3E,QAAM,YAAY;AAAA,IAChB,gBAAgB;AAAA,IAChB;AAAA,IACA;AAAA,IACA,aAAa;AAAA,EACf;AAEA,WAAS,kBAAAC,QAAW,YAAY,SAAS;AAC3C;AAQA,MAAM,cAAc,CAAC,KAAc,iBAAyB;AAE1D,QAAM,mBAAe,kDAAyB,IAAI,IAAI,IAAI,IAAI,YAAY,CAAC;AAE3E,QAAM,YAAY;AAAA,IAChB,gBAAgB;AAAA,IAChB,eAAe;AAAA,IACf,MAAM,IAAI;AAAA,EACZ;AAEA,WAAS,kBAAAA,QAAW,UAAU,SAAS;AACzC;AAWA,MAAM,eAAe,CACnB,KACA,SACA,UACA,UACA,gBACG;AAEH,QAAM,mBAAe,kDAAyB,IAAI,IAAI,IAAI,IAAI,YAAY,CAAC;AAE3E,QAAM,YAA6C;AAAA,IACjD,gBAAgB;AAAA,IAChB,UAAU;AAAA,IACV,MAAM,eAAe,IAAI;AAAA,EAC3B;AAEA,MAAI,UAAU;AACZ,cAAU,YAAY;AAAA,EACxB;AAEA,MAAI,UAAU;AACZ,cAAU,YAAY;AAAA,EACxB;AAEA,WAAS,kBAAAA,QAAW,YAAY,SAAS;AAC3C;AASA,MAAM,cAAc,CAAC,KAAc,UAAkB,mBAA4B;AAE/E,QAAM,mBAAe,kDAAyB,IAAI,IAAI,IAAI,IAAI,YAAY,CAAC;AAE3E,QAAM,YAA6C;AAAA,IACjD,gBAAgB;AAAA,IAChB,WAAW;AAAA,IACX,MAAM,IAAI;AAAA,EACZ;AAEA,MAAI,gBAAgB;AAClB,cAAU,kBAAkB;AAAA,EAC9B;AAEA,WAAS,kBAAAA,QAAW,WAAW,SAAS;AAC1C;AAQA,MAAM,eAAe,CAAC,KAAc,aAAqB;AAEvD,QAAM,mBAAe,kDAAyB,IAAI,IAAI,IAAI,IAAI,YAAY,CAAC;AAE3E,QAAM,YAAY;AAAA,IAChB,gBAAgB;AAAA,IAChB,WAAW;AAAA,IACX,MAAM,IAAI;AAAA,EACZ;AAEA,WAAS,kBAAAA,QAAW,YAAY,SAAS;AAC3C;",
  "names": ["config", "logger", "UserEvents"]
}
