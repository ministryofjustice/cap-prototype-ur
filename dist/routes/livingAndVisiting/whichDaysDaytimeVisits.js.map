{
  "version": 3,
  "sources": ["../../../server/routes/livingAndVisiting/whichDaysDaytimeVisits.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { Router } from 'express';\nimport { body, matchedData, validationResult } from 'express-validator';\n\nimport { whichDaysField } from '../../@types/fields';\nimport formFields from '../../constants/formFields';\nimport FORM_STEPS from '../../constants/formSteps';\nimport paths from '../../constants/paths';\nimport checkFormProgressFromConfig  from '../../middleware/checkFormProgressFromConfig';\nimport addCompletedStep from '../../utils/addCompletedStep';\nimport { convertWhichDaysFieldToSessionValue, convertWhichDaysSessionValueToField } from '../../utils/formValueUtils';\nimport { getSessionValue, setSessionSection } from '../../utils/perChildSession';\nimport { getBackUrl, getRedirectUrlAfterFormSubmit } from '../../utils/sessionHelpers';\n\nconst whichDaysDaytimeVisitsRoutes = (router: Router) => {\n  router.get(paths.LIVING_VISITING_WHICH_DAYS_DAYTIME_VISITS, checkFormProgressFromConfig(FORM_STEPS.LIVING_VISITING_WHICH_DAYS_DAYTIME_VISITS), (request, response) => {\n    const livingAndVisiting = getSessionValue<any>(request.session, 'livingAndVisiting');\n    const daytimeVisits = livingAndVisiting?.daytimeVisits;\n\n    const [previousDays, previousDescribeArrangement] = convertWhichDaysSessionValueToField(daytimeVisits?.whichDays);\n\n    const formValues = {\n      [formFields.WHICH_DAYS_DAYTIME_VISITS]: previousDays,\n      [formFields.WHICH_DAYS_DAYTIME_VISITS_DESCRIBE_ARRANGEMENT]: previousDescribeArrangement,\n      ...request.flash('formValues')?.[0],\n    };\n\n    response.render('pages/livingAndVisiting/whichDaysDaytimeVisits', {\n      errors: request.flash('errors'),\n      formValues,\n      title: request.__('livingAndVisiting.whichDaysDaytimeVisits.title'),\n      backLinkHref: getBackUrl(request.session, paths.LIVING_VISITING_WILL_DAYTIME_VISITS_HAPPEN),\n    });\n  });\n\n  router.post(\n    paths.LIVING_VISITING_WHICH_DAYS_DAYTIME_VISITS,\n    body(formFields.WHICH_DAYS_DAYTIME_VISITS_DESCRIBE_ARRANGEMENT)\n      .if(body(formFields.WHICH_DAYS_DAYTIME_VISITS).equals('other'))\n      .trim()\n      .notEmpty()\n      .withMessage((_value, { req }) => req.__('livingAndVisiting.whichDaysDaytimeVisits.arrangementMissingError')),\n    body(formFields.WHICH_DAYS_DAYTIME_VISITS)\n      .exists()\n      .toArray()\n      .withMessage((_value, { req }) => req.__('livingAndVisiting.whichDaysDaytimeVisits.emptyError')),\n    body(formFields.WHICH_DAYS_DAYTIME_VISITS)\n      .custom(\n        // This is prevented by JS in the page, but possible for people with JS disabled to submit\n        (whichDays: whichDaysField) => !(whichDays.length > 1 && whichDays.includes('other')),\n      )\n      .withMessage((_value, { req }) => req.__('livingAndVisiting.whichDaysDaytimeVisits.multiSelectedError')),\n    (request, response) => {\n      const formData = matchedData<{\n        [formFields.WHICH_DAYS_DAYTIME_VISITS_DESCRIBE_ARRANGEMENT]: string;\n        [formFields.WHICH_DAYS_DAYTIME_VISITS]: whichDaysField;\n      }>(request, { onlyValidData: false });\n\n      const errors = validationResult(request);\n\n      if (!errors.isEmpty()) {\n        request.flash('errors', errors.array());\n        request.flash('formValues', formData);\n        return response.redirect(paths.LIVING_VISITING_WHICH_DAYS_DAYTIME_VISITS);\n      }\n\n      const {\n        [formFields.WHICH_DAYS_DAYTIME_VISITS]: whichDays,\n        [formFields.WHICH_DAYS_DAYTIME_VISITS_DESCRIBE_ARRANGEMENT]: describeArrangement,\n      } = formData;\n\n      const livingAndVisiting = getSessionValue<any>(request.session, 'livingAndVisiting') || {};\n      setSessionSection(request.session, 'livingAndVisiting', {\n        ...livingAndVisiting,\n        daytimeVisits: {\n          ...livingAndVisiting.daytimeVisits,\n          whichDays: convertWhichDaysFieldToSessionValue(whichDays, describeArrangement),\n        },\n      });\n\n      addCompletedStep(request, FORM_STEPS.LIVING_VISITING_WHICH_DAYS_DAYTIME_VISITS);\n\n      return response.redirect(getRedirectUrlAfterFormSubmit(request.session, paths.TASK_LIST));\n    },\n  );\n\n  router.post(paths.LIVING_VISITING_WHICH_DAYS_DAYTIME_VISITS_NOT_REQUIRED, (request, response) => {\n    const livingAndVisiting = getSessionValue<any>(request.session, 'livingAndVisiting') || {};\n    setSessionSection(request.session, 'livingAndVisiting', {\n      ...livingAndVisiting,\n      daytimeVisits: {\n        willHappen: true,\n        whichDays: {\n          noDecisionRequired: true,\n        },\n      },\n    });\n\n    addCompletedStep(request, FORM_STEPS.LIVING_VISITING_WHICH_DAYS_DAYTIME_VISITS);\n\n    return response.redirect(getRedirectUrlAfterFormSubmit(request.session, paths.TASK_LIST));\n  });\n};\n\nexport default whichDaysDaytimeVisitsRoutes;\n"],
  "mappings": "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",
  "names": ["paths", "checkFormProgressFromConfig", "FORM_STEPS", "formFields", "addCompletedStep"]
}
