{
  "version": 3,
  "sources": ["../../../server/routes/livingAndVisiting/whichSchedule.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { Router } from 'express';\nimport { body, validationResult } from 'express-validator';\n\nimport { WhichScheduleAnswer } from '../../@types/session';\nimport formFields from '../../constants/formFields';\nimport FORM_STEPS from '../../constants/formSteps';\nimport paths from '../../constants/paths';\nimport checkFormProgressFromConfig  from '../../middleware/checkFormProgressFromConfig';\nimport addCompletedStep from '../../utils/addCompletedStep';\nimport { isDesign2, isDesign3, isDesign4, isPerChildPoCEnabled, getSessionValue, setSessionSection } from '../../utils/perChildSession';\nimport { getBackUrl, getRedirectUrlAfterFormSubmit } from '../../utils/sessionHelpers';\n\n// Helper to get the field name for a specific child index\nconst getFieldName = (childIndex: number) => `${formFields.WHICH_SCHEDULE}-${childIndex}`;\n\n// Helper to get the child selector field name for a specific entry index\nconst _getChildSelectorFieldName = (entryIndex: number) => `child-selector-${entryIndex}`;\n\n// Helper to safely get a trimmed string from request body\nconst safeString = (value: unknown): string => {\n  if (typeof value === 'string') {\n    return value.trim();\n  }\n  return '';\n};\n\nconst whichScheduleRoutes = (router: Router) => {\n  router.get(paths.LIVING_VISITING_WHICH_SCHEDULE, checkFormProgressFromConfig(FORM_STEPS.LIVING_VISITING_WHICH_SCHEDULE), (request, response) => {\n    const { numberOfChildren, namesOfChildren } = request.session;\n    const isD2 = isDesign2(request.session);\n    const activeChildIndex = isD2 ? (request.session.currentChildIndex ?? 0) : 0;\n    const activeChildName = isD2 ? namesOfChildren[activeChildIndex] : null;\n    const livingAndVisiting = getSessionValue<any>(request.session, 'livingAndVisiting');\n    const existingAnswers = livingAndVisiting?.whichSchedule;\n\n    // Build form values from existing session data\n    const formValues: Record<string, string> = {};\n\n    // Track which children have specific answers\n    const childrenWithAnswers: number[] = [];\n\n    if (existingAnswers) {\n      // Handle both old format (direct answer) and new PerChildAnswer format\n      if (existingAnswers.default?.answer) {\n        formValues[getFieldName(0)] = existingAnswers.default.answer;\n      } else if (existingAnswers.answer) {\n        // Legacy format - direct answer without default wrapper\n        formValues[getFieldName(0)] = existingAnswers.answer;\n      }\n\n      // Set per-child answers\n      if (existingAnswers.byChild) {\n        Object.entries(existingAnswers.byChild).forEach(([childIndex, answer]: [string, any]) => {\n          const idx = parseInt(childIndex, 10);\n          if (answer.answer) {\n            childrenWithAnswers.push(idx);\n            formValues[getFieldName(idx)] = answer.answer;\n          }\n        });\n      }\n    }\n\n    // Merge with flash values\n    const flashValues = request.flash('formValues')?.[0] || {};\n\n    // Build list of children for dropdown options\n    const childOptions = namesOfChildren.map((name, index) => ({\n      value: index.toString(),\n      text: name,\n    }));\n\n    response.render('pages/livingAndVisiting/whichSchedule', {\n      errors: request.flash('errors'),\n      title: isD2 ? `What is ${activeChildName}'s schedule?` : request.__('livingAndVisiting.whichSchedule.title'),\n      formValues: { ...formValues, ...flashValues },\n      backLinkHref: getBackUrl(request.session, paths.LIVING_VISITING_MOSTLY_LIVE),\n      numberOfChildren,\n      namesOfChildren,\n      childOptions,\n      childrenWithAnswers,\n      childProgressCaption: isD2 ? `Child ${activeChildIndex + 1} of ${numberOfChildren}` : null,\n      showPerChildOption: numberOfChildren > 1 && !isD2 && !isDesign3(request.session) && isPerChildPoCEnabled(request.session),\n      showDesign3Option: numberOfChildren > 1 && isDesign3(request.session) && isPerChildPoCEnabled(request.session),\n      designMode: request.session.perChildDesignMode || 'design1',\n    });\n  });\n\n  router.post(\n    paths.LIVING_VISITING_WHICH_SCHEDULE,\n    (request, response, next) => {\n      const { numberOfChildren } = request.session;\n\n      // Dynamic validation based on submitted fields\n      const validations: ReturnType<typeof body>[] = [];\n\n      // Always validate the default/first answer\n      validations.push(\n        body(getFieldName(0))\n          .trim()\n          .notEmpty()\n          .withMessage((_value, { req }) => req.__('livingAndVisiting.whichSchedule.error'))\n      );\n\n      // Check for per-child entries and validate them\n      for (let i = 1; i <= numberOfChildren; i++) {\n        const fieldName = getFieldName(i);\n        // Only validate if the field exists in the request\n        if (request.body[fieldName] !== undefined && request.body[fieldName] !== '') {\n          validations.push(\n            body(fieldName)\n              .trim()\n              .notEmpty()\n              .withMessage((_value, { req }) => req.__('livingAndVisiting.whichSchedule.error'))\n          );\n        }\n      }\n\n      // Run all validations\n      Promise.all(validations.map(validation => validation.run(request)))\n        .then(() => next())\n        .catch(next);\n    },\n    (request, response) => {\n      // Design 3: handle \"specify per child\" - switch to per-child (Design 2) mode\n      if (isDesign3(request.session) && request.body['specify-per-child'] === 'yes') {\n        request.session.perChildDesignMode = 'design2' as any;\n        request.session.currentChildIndex = 0;\n        if (!request.session.childPlans || request.session.childPlans.length === 0) {\n          request.session.childPlans = (request.session.namesOfChildren || []).map((name: string, index: number) => ({\n            childIndex: index,\n            childName: name,\n            isComplete: false,\n          }));\n        }\n        return response.redirect(paths.LIVING_VISITING_WHICH_SCHEDULE);\n      }\n\n      const errors = validationResult(request);\n\n      if (!errors.isEmpty()) {\n        request.flash('errors', errors.array());\n        request.flash('formValues', request.body);\n        return response.redirect(paths.LIVING_VISITING_WHICH_SCHEDULE);\n      }\n\n      // Process the default answer\n      const defaultAnswer = safeString(request.body[getFieldName(0)]);\n\n      // Build the per-child answers structure\n      const byChild: Record<number, WhichScheduleAnswer> = {};\n\n      // Check for additional per-child entries\n      let additionalEntries: Array<{childIndex: number, answer: string, entryIndex: number}>;\n\n      if (isDesign4(request.session)) {\n        // Design 4: checkboxes can select multiple children per entry\n        additionalEntries = Object.keys(request.body)\n          .filter(key => /^child-checkbox-\\d+$/.test(key))\n          .flatMap(key => {\n            const entryIndex = parseInt(key.replace('child-checkbox-', ''), 10);\n            const rawValues = request.body[key];\n            const childIndices = (Array.isArray(rawValues) ? rawValues : [rawValues])\n              .map((v: string) => parseInt(v, 10))\n              .filter((v: number) => !isNaN(v));\n            const answerFieldName = getFieldName(entryIndex);\n            const answer = safeString(request.body[answerFieldName]);\n            return childIndices.map(childIndex => ({ childIndex, answer, entryIndex }));\n          })\n          .filter(entry => entry.answer);\n      } else {\n        // Design 1: SELECT dropdown with single child\n        additionalEntries = Object.keys(request.body)\n          .filter(key => key.startsWith('child-selector-'))\n          .map(key => {\n            const entryIndex = parseInt(key.replace('child-selector-', ''), 10);\n            const childIndex = parseInt(request.body[key], 10);\n            const answerFieldName = getFieldName(entryIndex);\n            const answer = safeString(request.body[answerFieldName]);\n            return { childIndex, answer, entryIndex };\n          })\n          .filter(entry => !isNaN(entry.childIndex) && entry.answer);\n      }\n\n      // Store per-child answers\n      additionalEntries.forEach(entry => {\n        byChild[entry.childIndex] = {\n          noDecisionRequired: false,\n          answer: entry.answer,\n        };\n      });\n\n      const newWhichSchedule = {\n        default: {\n          noDecisionRequired: false,\n          answer: defaultAnswer,\n        },\n        ...(Object.keys(byChild).length > 0 ? { byChild } : {}),\n      };\n\n      const livingAndVisiting = getSessionValue<any>(request.session, 'livingAndVisiting') || {};\n      setSessionSection(request.session, 'livingAndVisiting', { ...livingAndVisiting, whichSchedule: newWhichSchedule });\n      addCompletedStep(request, FORM_STEPS.LIVING_VISITING_WHICH_SCHEDULE);\n\n      if (isDesign2(request.session)) {\n        if (request.body['apply-to-all'] === 'yes') {\n          const savedIndex = request.session.currentChildIndex ?? 0;\n          for (let i = 0; i < request.session.numberOfChildren; i++) {\n            if (i !== savedIndex) {\n              request.session.currentChildIndex = i;\n              const childLAV = getSessionValue<any>(request.session, 'livingAndVisiting') || {};\n              setSessionSection(request.session, 'livingAndVisiting', { ...childLAV, whichSchedule: newWhichSchedule });\n            }\n          }\n          request.session.currentChildIndex = 0;\n          return response.redirect(paths.TASK_LIST);\n        }\n        const nextChildIndex = (request.session.currentChildIndex ?? 0) + 1;\n        if (nextChildIndex < request.session.numberOfChildren) {\n          request.session.currentChildIndex = nextChildIndex;\n          return response.redirect(paths.LIVING_VISITING_WHICH_SCHEDULE);\n        }\n        request.session.currentChildIndex = 0;\n        return response.redirect(paths.TASK_LIST);\n      }\n\n      return response.redirect(getRedirectUrlAfterFormSubmit(request.session, paths.TASK_LIST));\n    },\n  );\n\n  router.post(paths.LIVING_VISITING_WHICH_SCHEDULE_NOT_REQUIRED, (request, response) => {\n    const livingAndVisiting = getSessionValue<any>(request.session, 'livingAndVisiting') || {};\n    setSessionSection(request.session, 'livingAndVisiting', {\n      ...livingAndVisiting,\n      whichSchedule: {\n        default: {\n          noDecisionRequired: true,\n        },\n      },\n    });\n    addCompletedStep(request, FORM_STEPS.LIVING_VISITING_WHICH_SCHEDULE);\n\n    return response.redirect(getRedirectUrlAfterFormSubmit(request.session, paths.TASK_LIST));\n  });\n};\n\nexport default whichScheduleRoutes;\n"],
  "mappings": "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",
  "names": ["formFields", "paths", "checkFormProgressFromConfig", "FORM_STEPS", "addCompletedStep"]
}
