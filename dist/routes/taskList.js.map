{
  "version": 3,
  "sources": ["../../server/routes/taskList.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { Router } from 'express';\n\nimport { ChildPlan } from '../@types/session';\nimport FORM_STEPS from '../constants/formSteps';\nimport paths from '../constants/paths';\nimport checkFormProgressFromConfig from '../middleware/checkFormProgressFromConfig';\nimport addCompletedStep from '../utils/addCompletedStep';\nimport {\n  formattedChildrenNames,\n  mostlyLiveComplete,\n  getBetweenHouseholdsComplete,\n  whereHandoverComplete,\n  willChangeDuringSchoolHolidaysComplete,\n  itemsForChangeoverComplete,\n  whatWillHappenComplete,\n  whatOtherThingsMatterComplete,\n  planLastMinuteChangesComplete,\n  planLongTermNoticeComplete,\n  planReviewComplete,\n} from '../utils/sessionHelpers';\n\n/**\n * Check if a child plan is complete (Design 2)\n */\nconst isChildPlanComplete = (plan: ChildPlan | undefined): boolean => {\n  if (!plan) return false;\n\n  // Check all required sections\n  const hasLivingAndVisiting = !!plan.livingAndVisiting?.mostlyLive;\n  const hasHandover = !!plan.handoverAndHolidays?.getBetweenHouseholds;\n  const hasWhereHandover = !!plan.handoverAndHolidays?.whereHandover;\n  const hasSchoolHolidays =\n    !!plan.handoverAndHolidays?.willChangeDuringSchoolHolidays ||\n    !!plan.handoverAndHolidays?.howChangeDuringSchoolHolidays;\n  const hasItems = !!plan.handoverAndHolidays?.itemsForChangeover;\n  const hasSpecialDays = !!plan.specialDays?.whatWillHappen;\n  const hasOtherThings = !!plan.otherThings?.whatOtherThingsMatter;\n  const hasDecisionMaking =\n    !!plan.decisionMaking?.planLastMinuteChanges &&\n    !!plan.decisionMaking?.planLongTermNotice &&\n    !!plan.decisionMaking?.planReview;\n\n  return (\n    hasLivingAndVisiting &&\n    hasHandover &&\n    hasWhereHandover &&\n    hasSchoolHolidays &&\n    hasItems &&\n    hasSpecialDays &&\n    hasOtherThings &&\n    hasDecisionMaking\n  );\n};\n\nconst taskListRoutes = (router: Router) => {\n  router.get(paths.TASK_LIST, checkFormProgressFromConfig(FORM_STEPS.TASK_LIST), (request, response) => {\n    const { numberOfChildren, namesOfChildren, perChildDesignMode, currentChildIndex, childPlans } = request.session;\n\n    // Determine which design mode we're in (default to design1)\n    const designMode = perChildDesignMode || 'design1';\n    const isDesign2Mode = designMode === 'design2' && numberOfChildren > 1;\n    const isDesign3Mode = designMode === 'design3';\n    const isDesign4Mode = designMode === 'design4';\n\n    // Design 1: Check completion status from main session\n    const isMostlyLiveComplete = mostlyLiveComplete(request.session);\n    const isGetBetweenHouseholdsComplete = getBetweenHouseholdsComplete(request.session);\n    const isWhereHandoverComplete = whereHandoverComplete(request.session);\n    const isWillChangeDuringSchoolHolidaysComplete = willChangeDuringSchoolHolidaysComplete(request.session);\n    const isItemsForChangeoverComplete = itemsForChangeoverComplete(request.session);\n    const isWhatWillHappenComplete = whatWillHappenComplete(request.session);\n    const isWhatOtherThingsMatterComplete = whatOtherThingsMatterComplete(request.session);\n    const isPlanLastMinuteChangesComplete = planLastMinuteChangesComplete(request.session);\n    const isPlanLongTermNoticeComplete = planLongTermNoticeComplete(request.session);\n    const isPlanReviewComplete = planReviewComplete(request.session);\n\n    addCompletedStep(request, FORM_STEPS.TASK_LIST);\n\n    // Design 2 specific data\n    let design2Data = {};\n    if (isDesign2Mode) {\n      // Initialize child plans if needed\n      let plans = childPlans || [];\n      if (plans.length === 0) {\n        plans = namesOfChildren.map((name, index) => ({\n          childIndex: index,\n          childName: name,\n          isComplete: false,\n        }));\n        request.session.childPlans = plans;\n      }\n\n      // Ensure current child index is valid\n      const activeChildIndex =\n        currentChildIndex !== undefined && currentChildIndex < numberOfChildren ? currentChildIndex : 0;\n      if (request.session.currentChildIndex !== activeChildIndex) {\n        request.session.currentChildIndex = activeChildIndex;\n      }\n\n      // Calculate completion status for each child\n      const childPlanStatuses = plans.map((plan) => ({\n        ...plan,\n        isComplete: isChildPlanComplete(plan),\n      }));\n\n      // Get children that can be copied from (those with any data)\n      const childrenWithData = plans.filter(\n        (plan) =>\n          plan.livingAndVisiting ||\n          plan.handoverAndHolidays ||\n          plan.specialDays ||\n          plan.otherThings ||\n          plan.decisionMaking,\n      );\n\n      design2Data = {\n        isDesign2: true,\n        currentChildIndex: activeChildIndex,\n        currentChildName: namesOfChildren[activeChildIndex],\n        childPlanStatuses,\n        childrenWithData,\n        allChildrenComplete: childPlanStatuses.every((p) => p.isComplete),\n      };\n    }\n\n    // For Design 2, require all children to be complete\n    const allTasksComplete =\n      isWhatWillHappenComplete &&\n      isMostlyLiveComplete &&\n      isGetBetweenHouseholdsComplete &&\n      isWhereHandoverComplete &&\n      isWillChangeDuringSchoolHolidaysComplete &&\n      isItemsForChangeoverComplete &&\n      isWhatOtherThingsMatterComplete &&\n      isPlanLastMinuteChangesComplete &&\n      isPlanLongTermNoticeComplete &&\n      isPlanReviewComplete;\n\n    const showContinueButton = isDesign2Mode\n      ? allTasksComplete && (design2Data as any).allChildrenComplete\n      : allTasksComplete;\n\n    response.render('pages/taskList', {\n      title: request.__('taskList.title', { names: formattedChildrenNames(request) }),\n      // Design mode toggle - hidden for now, keeping Design 1 as the default\n      designMode,\n      designModeLabel: designMode === 'design1' ? 'Design 1: Answer for all, then specify per child (dropdown)' :\n                       designMode === 'design2' ? 'Design 2: Answer for each child separately' :\n                       designMode === 'design3' ? 'Design 3: Answer once, then specify per child' :\n                       designMode === 'design4' ? 'Design 4: Answer for all, then specify per child (checkboxes)' : null,\n      showDesignToggle: false,\n      numberOfChildren,\n      namesOfChildren,\n      // This should only be true when all tasks are complete\n      showContinue: showContinueButton,\n      mostlyLiveComplete: isMostlyLiveComplete,\n      getBetweenHouseholdsComplete: isGetBetweenHouseholdsComplete,\n      whereHandoverComplete: isWhereHandoverComplete,\n      willChangeDuringSchoolHolidaysComplete: isWillChangeDuringSchoolHolidaysComplete,\n      itemsForChangeoverComplete: isItemsForChangeoverComplete,\n      whatWillHappenComplete: isWhatWillHappenComplete,\n      whatOtherThingsMatterComplete: isWhatOtherThingsMatterComplete,\n      planLastMinuteChangesComplete: isPlanLastMinuteChangesComplete,\n      planLongTermNoticeComplete: isPlanLongTermNoticeComplete,\n      planReviewComplete: isPlanReviewComplete,\n      // Design 2 specific data\n      ...design2Data,\n    });\n  });\n};\n\nexport default taskListRoutes;\n"],
  "mappings": "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",
  "names": ["paths", "checkFormProgressFromConfig", "FORM_STEPS", "addCompletedStep"]
}
