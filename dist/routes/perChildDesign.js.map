{
  "version": 3,
  "sources": ["../../server/routes/perChildDesign.ts"],
  "sourcesContent": ["import { Router } from 'express';\nimport { body, validationResult } from 'express-validator';\n\nimport { PerChildDesignMode } from '../@types/session';\nimport paths from '../constants/paths';\n\n/**\n * Routes for managing per-child design mode toggle and Design 2 functionality\n */\nconst perChildDesignRoutes = (router: Router) => {\n  /**\n   * POST: Toggle between Design 1 (inline per-child) and Design 2 (task list level)\n   */\n  router.post(paths.TOGGLE_DESIGN_MODE, (request, response) => {\n    const newMode = request.body.designMode as PerChildDesignMode;\n\n    if (!['design1', 'design2', 'design3', 'design4'].includes(newMode)) {\n      return response.redirect(paths.TASK_LIST);\n    }\n\n    request.session.perChildDesignMode = newMode;\n\n    // If switching to Design 2, initialize child plans if needed\n    if (newMode === 'design2' && request.session.numberOfChildren > 0) {\n      initializeChildPlans(request);\n    }\n\n    return response.redirect(paths.TASK_LIST);\n  });\n\n  /**\n   * POST: Select which child's plan to edit (Design 2)\n   */\n  router.post(\n    paths.SELECT_CHILD,\n    body('childIndex').isInt({ min: 0 }).toInt(),\n    (request, response) => {\n      const errors = validationResult(request);\n      if (!errors.isEmpty()) {\n        return response.redirect(paths.TASK_LIST);\n      }\n\n      const childIndex = parseInt(request.body.childIndex, 10);\n\n      // Validate child index is within range\n      if (childIndex >= request.session.numberOfChildren) {\n        return response.redirect(paths.TASK_LIST);\n      }\n\n      request.session.currentChildIndex = childIndex;\n\n      // Ensure child plan exists\n      initializeChildPlans(request);\n\n      return response.redirect(paths.TASK_LIST);\n    },\n  );\n\n  /**\n   * POST: Copy a child's plan to another child (Design 2)\n   */\n  router.post(\n    paths.COPY_CHILD_PLAN,\n    body('sourceChildIndex').isInt({ min: 0 }).toInt(),\n    body('targetChildIndex').isInt({ min: 0 }).toInt(),\n    (request, response) => {\n      const errors = validationResult(request);\n      if (!errors.isEmpty()) {\n        return response.redirect(paths.TASK_LIST);\n      }\n\n      const sourceIndex = parseInt(request.body.sourceChildIndex, 10);\n      const targetIndex = parseInt(request.body.targetChildIndex, 10);\n\n      // Validate indices\n      if (\n        sourceIndex >= request.session.numberOfChildren ||\n        targetIndex >= request.session.numberOfChildren ||\n        sourceIndex === targetIndex\n      ) {\n        return response.redirect(paths.TASK_LIST);\n      }\n\n      // Ensure child plans exist\n      initializeChildPlans(request);\n\n      const { childPlans, namesOfChildren } = request.session;\n      const sourcePlan = childPlans?.find((p) => p.childIndex === sourceIndex);\n\n      if (sourcePlan && childPlans) {\n        // Find or create target plan\n        let targetPlan = childPlans.find((p) => p.childIndex === targetIndex);\n        if (!targetPlan) {\n          targetPlan = {\n            childIndex: targetIndex,\n            childName: namesOfChildren[targetIndex],\n            isComplete: false,\n          };\n          childPlans.push(targetPlan);\n        }\n\n        // Deep copy the plan data\n        targetPlan.livingAndVisiting = JSON.parse(JSON.stringify(sourcePlan.livingAndVisiting || {}));\n        targetPlan.handoverAndHolidays = JSON.parse(JSON.stringify(sourcePlan.handoverAndHolidays || {}));\n        targetPlan.specialDays = JSON.parse(JSON.stringify(sourcePlan.specialDays || {}));\n        targetPlan.otherThings = JSON.parse(JSON.stringify(sourcePlan.otherThings || {}));\n        targetPlan.decisionMaking = JSON.parse(JSON.stringify(sourcePlan.decisionMaking || {}));\n        targetPlan.copiedFromChildIndex = sourceIndex;\n        targetPlan.isComplete = sourcePlan.isComplete;\n\n        request.session.childPlans = childPlans;\n      }\n\n      // Switch to the target child\n      request.session.currentChildIndex = targetIndex;\n\n      return response.redirect(paths.TASK_LIST);\n    },\n  );\n};\n\n/**\n * Helper to initialize child plans if they don't exist\n */\nfunction initializeChildPlans(request: Express.Request) {\n  const { numberOfChildren, namesOfChildren, childPlans } = request.session;\n\n  if (!childPlans || childPlans.length === 0) {\n    request.session.childPlans = [];\n    for (let i = 0; i < numberOfChildren; i++) {\n      request.session.childPlans.push({\n        childIndex: i,\n        childName: namesOfChildren[i],\n        isComplete: false,\n      });\n    }\n  }\n\n  // Set current child index if not set\n  if (request.session.currentChildIndex === undefined) {\n    request.session.currentChildIndex = 0;\n  }\n}\n\nexport default perChildDesignRoutes;\n"],
  "mappings": "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",
  "names": ["paths"]
}
