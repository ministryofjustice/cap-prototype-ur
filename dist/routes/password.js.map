{
  "version": 3,
  "sources": ["../../server/routes/password.ts"],
  "sourcesContent": ["import type { Response, Request, Router } from 'express-serve-static-core';\nimport { body, validationResult } from 'express-validator';\n\nimport config from '../config';\nimport cookieNames from '../constants/cookieNames';\nimport formFields from '../constants/formFields';\nimport paths from '../constants/paths';\nimport logger from '../logging/logger';\nimport encryptPassword from '../utils/encryptPassword';\nimport { validateRedirectUrl } from '../utils/redirectValidator';\n\nconst passwordRoutes = (router: Router) => {\n  router.get(paths.PASSWORD, handleGetPassword);\n  router.post(\n    paths.PASSWORD,\n    body(formFields.PASSWORD)\n      .custom((submittedPassword: string) => {\n        return config.passwords.some((p) => submittedPassword === p);\n      })\n      .withMessage('The password is not correct'),\n    handlePostPassword,\n  );\n};\n\nconst handlePostPassword = (request: Request, response: Response) => {\n  const providedUrl = typeof request.body.returnURL === 'string' ? request.body.returnURL : null;\n  // Validate redirect URL against whitelist to prevent open redirect attacks\n  const processedRedirectUrl = validateRedirectUrl(providedUrl, paths.START);\n  const errors = validationResult(request);\n\n  if (errors.isEmpty()) {\n    response.cookie(cookieNames.AUTHENTICATION, encryptPassword(request.body.password), {\n      maxAge: 1000 * 60 * 60 * 24 * 30, // 30 days\n      secure: config.useHttps,\n      httpOnly: true,\n      sameSite: 'lax',\n    });\n    logger.info(`Received successful login request`);\n    // Safe to redirect: processedRedirectUrl has been validated against whitelist\n    return response.redirect(processedRedirectUrl.replace(/^\\/+/, '/'));\n  }\n\n  request.flash('errors', errors.array());\n  return response.redirect(`${paths.PASSWORD}?returnURL=${encodeURIComponent(processedRedirectUrl)}`);\n};\n\nconst handleGetPassword = async (request: Request, response: Response) => {\n  const providedReturnURL = typeof request.query.returnURL === 'string' ? request.query.returnURL : undefined;\n  const returnURL = validateRedirectUrl(providedReturnURL, paths.START);\n\n  response.render('pages/password', { returnURL, errors: request.flash('errors'), title: 'Sign in' });\n};\n\nexport default passwordRoutes;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AACA,+BAAuC;AAEvC,oBAAmB;AACnB,yBAAwB;AACxB,wBAAuB;AACvB,mBAAkB;AAClB,oBAAmB;AACnB,6BAA4B;AAC5B,+BAAoC;AAEpC,MAAM,iBAAiB,CAAC,WAAmB;AACzC,SAAO,IAAI,aAAAA,QAAM,UAAU,iBAAiB;AAC5C,SAAO;AAAA,IACL,aAAAA,QAAM;AAAA,QACN,+BAAK,kBAAAC,QAAW,QAAQ,EACrB,OAAO,CAAC,sBAA8B;AACrC,aAAO,cAAAC,QAAO,UAAU,KAAK,CAAC,MAAM,sBAAsB,CAAC;AAAA,IAC7D,CAAC,EACA,YAAY,6BAA6B;AAAA,IAC5C;AAAA,EACF;AACF;AAEA,MAAM,qBAAqB,CAAC,SAAkB,aAAuB;AACnE,QAAM,cAAc,OAAO,QAAQ,KAAK,cAAc,WAAW,QAAQ,KAAK,YAAY;AAE1F,QAAM,2BAAuB,8CAAoB,aAAa,aAAAF,QAAM,KAAK;AACzE,QAAM,aAAS,2CAAiB,OAAO;AAEvC,MAAI,OAAO,QAAQ,GAAG;AACpB,aAAS,OAAO,mBAAAG,QAAY,oBAAgB,uBAAAC,SAAgB,QAAQ,KAAK,QAAQ,GAAG;AAAA,MAClF,QAAQ,MAAO,KAAK,KAAK,KAAK;AAAA;AAAA,MAC9B,QAAQ,cAAAF,QAAO;AAAA,MACf,UAAU;AAAA,MACV,UAAU;AAAA,IACZ,CAAC;AACD,kBAAAG,QAAO,KAAK,mCAAmC;AAE/C,WAAO,SAAS,SAAS,qBAAqB,QAAQ,QAAQ,GAAG,CAAC;AAAA,EACpE;AAEA,UAAQ,MAAM,UAAU,OAAO,MAAM,CAAC;AACtC,SAAO,SAAS,SAAS,GAAG,aAAAL,QAAM,QAAQ,cAAc,mBAAmB,oBAAoB,CAAC,EAAE;AACpG;AAEA,MAAM,oBAAoB,OAAO,SAAkB,aAAuB;AACxE,QAAM,oBAAoB,OAAO,QAAQ,MAAM,cAAc,WAAW,QAAQ,MAAM,YAAY;AAClG,QAAM,gBAAY,8CAAoB,mBAAmB,aAAAA,QAAM,KAAK;AAEpE,WAAS,OAAO,kBAAkB,EAAE,WAAW,QAAQ,QAAQ,MAAM,QAAQ,GAAG,OAAO,UAAU,CAAC;AACpG;AAEA,IAAO,mBAAQ;",
  "names": ["paths", "formFields", "config", "cookieNames", "encryptPassword", "logger"]
}
