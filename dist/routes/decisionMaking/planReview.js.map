{
  "version": 3,
  "sources": ["../../../server/routes/decisionMaking/planReview.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { Router } from 'express';\nimport { body, matchedData, validationResult } from 'express-validator';\n\nimport formFields from '../../constants/formFields';\nimport FORM_STEPS from '../../constants/formSteps';\nimport paths from '../../constants/paths';\nimport checkFormProgressFromConfig  from '../../middleware/checkFormProgressFromConfig';\nimport addCompletedStep from '../../utils/addCompletedStep';\nimport { getSessionValue, setSessionSection } from '../../utils/perChildSession';\nimport { getBackUrl, getRedirectUrlAfterFormSubmit } from '../../utils/sessionHelpers';\n\nconst planReviewRoutes = (router: Router) => {\n  router.get(paths.DECISION_MAKING_PLAN_REVIEW, checkFormProgressFromConfig(FORM_STEPS.DECISION_MAKING_PLAN_REVIEW), (request, response) => {\n    const decisionMaking = getSessionValue<any>(request.session, 'decisionMaking');\n    const planReview = decisionMaking?.planReview;\n\n    const formValues = {\n      [formFields.PLAN_REVIEW_MONTHS]: planReview?.months,\n      [formFields.PLAN_REVIEW_YEARS]: planReview?.years,\n      ...request.flash('formValues')?.[0],\n    };\n    response.render('pages/decisionMaking/planReview', {\n      errors: request.flash('errors'),\n      formValues,\n      title: request.__('decisionMaking.planReview.title'),\n      backLinkHref: getBackUrl(request.session, paths.DECISION_MAKING_PLAN_LONG_TERM_NOTICE),\n    });\n  });\n\n  const getMonthYearValidation = (formField: formFields, otherFromField: formFields) =>\n    body(formField)\n      .trim()\n      .custom((value: string, { req }) => value || req.body[otherFromField])\n      .withMessage((_value, { req }) => req.__('decisionMaking.planReview.bothEmptyError'))\n      .bail()\n      .custom((value: string, { req }) => !(value && req.body[otherFromField]))\n      .withMessage((_value, { req }) => req.__('decisionMaking.planReview.bothFilledError'))\n      .bail()\n      .if(body(otherFromField).isEmpty())\n      .isNumeric()\n      .withMessage((_value, { req }) => req.__('decisionMaking.planReview.notNumberError'))\n      .bail()\n      .if(body(otherFromField).isEmpty())\n      .isInt({ min: 0 })\n      .withMessage((_value, { req }) => req.__('decisionMaking.planReview.notIntError'));\n\n  router.post(\n    paths.DECISION_MAKING_PLAN_REVIEW,\n    getMonthYearValidation(formFields.PLAN_REVIEW_MONTHS, formFields.PLAN_REVIEW_YEARS),\n    getMonthYearValidation(formFields.PLAN_REVIEW_YEARS, formFields.PLAN_REVIEW_MONTHS),\n\n    (request, response) => {\n      const formData = matchedData<{\n        [formFields.PLAN_REVIEW_MONTHS]: string;\n        [formFields.PLAN_REVIEW_YEARS]: string;\n      }>(request, { onlyValidData: false });\n\n      const errors = validationResult(request);\n\n      if (!errors.isEmpty()) {\n        request.flash('errors', errors.array());\n        request.flash('formValues', formData);\n        return response.redirect(paths.DECISION_MAKING_PLAN_REVIEW);\n      }\n\n      const { [formFields.PLAN_REVIEW_MONTHS]: months, [formFields.PLAN_REVIEW_YEARS]: years } = formData;\n\n      const decisionMaking = getSessionValue<any>(request.session, 'decisionMaking') || {};\n      setSessionSection(request.session, 'decisionMaking', {\n        ...decisionMaking,\n        planReview: {\n          months: months ? parseInt(months) : undefined,\n          years: years ? parseInt(years) : undefined,\n        },\n      });\n\n      addCompletedStep(request, FORM_STEPS.DECISION_MAKING_PLAN_REVIEW);\n      return response.redirect(getRedirectUrlAfterFormSubmit(request.session, paths.TASK_LIST));\n    },\n  );\n};\n\nexport default planReviewRoutes;\n"],
  "mappings": "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",
  "names": ["paths", "checkFormProgressFromConfig", "FORM_STEPS", "formFields", "addCompletedStep"]
}
