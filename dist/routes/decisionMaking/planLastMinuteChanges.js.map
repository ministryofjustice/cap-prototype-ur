{
  "version": 3,
  "sources": ["../../../server/routes/decisionMaking/planLastMinuteChanges.ts"],
  "sourcesContent": ["/* eslint-disable @typescript-eslint/no-explicit-any */\nimport { Router } from 'express';\nimport { body, matchedData, validationResult } from 'express-validator';\n\nimport { planLastMinuteChangesField } from '../../@types/fields';\nimport formFields from '../../constants/formFields';\nimport FORM_STEPS from '../../constants/formSteps';\nimport paths from '../../constants/paths';\nimport checkFormProgressFromConfig  from '../../middleware/checkFormProgressFromConfig';\nimport addCompletedStep from '../../utils/addCompletedStep';\nimport { getSessionValue, setSessionSection } from '../../utils/perChildSession';\nimport { getBackUrl } from '../../utils/sessionHelpers';\n\nconst planLastMinuteChangesRoutes = (router: Router) => {\n  router.get(paths.DECISION_MAKING_PLAN_LAST_MINUTE_CHANGES, checkFormProgressFromConfig(FORM_STEPS.DECISION_MAKING_PLAN_LAST_MINUTE_CHANGES), (request, response) => {\n    const decisionMaking = getSessionValue<any>(request.session, 'decisionMaking');\n    const planLastMinuteChanges = decisionMaking?.planLastMinuteChanges;\n\n    const formValues = {\n      [formFields.PLAN_LAST_MINUTE_CHANGES]: planLastMinuteChanges?.options,\n      [formFields.PLAN_LAST_MINUTE_CHANGES_DESCRIBE_ARRANGEMENT]: planLastMinuteChanges?.anotherArrangementDescription,\n      ...request.flash('formValues')?.[0],\n    };\n    response.render('pages/decisionMaking/planLastMinuteChanges', {\n      errors: request.flash('errors'),\n      formValues,\n      title: request.__('decisionMaking.planLastMinuteChanges.title'),\n      backLinkHref: getBackUrl(request.session, paths.TASK_LIST),\n    });\n  });\n\n  router.post(\n    paths.DECISION_MAKING_PLAN_LAST_MINUTE_CHANGES,\n    body(formFields.PLAN_LAST_MINUTE_CHANGES_DESCRIBE_ARRANGEMENT)\n      .if(body(formFields.PLAN_LAST_MINUTE_CHANGES).equals('anotherArrangement'))\n      .trim()\n      .notEmpty()\n      .withMessage((_value, { req }) => req.__('decisionMaking.planLastMinuteChanges.descriptionEmptyError')),\n    body(formFields.PLAN_LAST_MINUTE_CHANGES)\n      .notEmpty()\n      .withMessage((_value, { req }) => req.__('decisionMaking.planLastMinuteChanges.emptyError'))\n      .toArray(),\n    body(formFields.PLAN_LAST_MINUTE_CHANGES)\n      .custom(\n        // This is prevented by JS in the page, but possible for people with JS disabled to submit\n        (planLastMinuteChanges: string | string[]) =>\n          !(planLastMinuteChanges.length > 1 && planLastMinuteChanges.includes('anotherArrangement')),\n      )\n      .withMessage((_value, { req }) => req.__('decisionMaking.planLastMinuteChanges.selectOneOptionError')),\n    (request, response) => {\n      const formData = matchedData<{\n        [formFields.PLAN_LAST_MINUTE_CHANGES_DESCRIBE_ARRANGEMENT]: string;\n        [formFields.PLAN_LAST_MINUTE_CHANGES]: planLastMinuteChangesField[];\n      }>(request, { onlyValidData: false });\n\n      const errors = validationResult(request);\n\n      if (!errors.isEmpty()) {\n        request.flash('errors', errors.array());\n        request.flash('formValues', formData);\n        return response.redirect(paths.DECISION_MAKING_PLAN_LAST_MINUTE_CHANGES);\n      }\n\n      const {\n        [formFields.PLAN_LAST_MINUTE_CHANGES]: options,\n        [formFields.PLAN_LAST_MINUTE_CHANGES_DESCRIBE_ARRANGEMENT]: describeArrangement,\n      } = formData;\n\n      const decisionMaking = getSessionValue<any>(request.session, 'decisionMaking') || {};\n      setSessionSection(request.session, 'decisionMaking', {\n        ...decisionMaking,\n        planLastMinuteChanges: {\n          noDecisionRequired: false,\n          options,\n          anotherArrangementDescription: options.includes('anotherArrangement') ? describeArrangement : undefined,\n        },\n      });\n      addCompletedStep(request, FORM_STEPS.DECISION_MAKING_PLAN_LAST_MINUTE_CHANGES);\n      return response.redirect(paths.DECISION_MAKING_PLAN_LONG_TERM_NOTICE);\n    },\n  );\n\n  router.post(paths.DECISION_MAKING_PLAN_LAST_MINUTE_CHANGES_NOT_REQUIRED, (request, response) => {\n    const decisionMaking = getSessionValue<any>(request.session, 'decisionMaking') || {};\n    setSessionSection(request.session, 'decisionMaking', {\n      ...decisionMaking,\n      planLastMinuteChanges: {\n        noDecisionRequired: true,\n      },\n    });\n\n    addCompletedStep(request, FORM_STEPS.DECISION_MAKING_PLAN_LAST_MINUTE_CHANGES);\n    return response.redirect(paths.DECISION_MAKING_PLAN_LONG_TERM_NOTICE);\n  });\n};\n\nexport default planLastMinuteChangesRoutes;\n"],
  "mappings": "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",
  "names": ["paths", "checkFormProgressFromConfig", "FORM_STEPS", "formFields", "addCompletedStep"]
}
