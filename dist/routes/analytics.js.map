{
  "version": 3,
  "sources": ["../../server/routes/analytics.ts"],
  "sourcesContent": ["import { Request, Response, NextFunction, Router } from 'express';\n\nimport { logLinkClick, logPageExit, logQuickExit } from '../services/analyticsService';\n\n/**\n * Prevents analytics requests from saving the session back to Redis.\n * Without this, `resave: true` causes analytics beacons (fired during\n * beforeunload/visibilitychange) to race with form-submission POSTs,\n * potentially overwriting freshly-written completedSteps data in Redis.\n * See PR #194 for prior history of this bug.\n */\nfunction skipSessionSave(req: Request, _res: Response, next: NextFunction) {\n  if (req.session) {\n    req.session.save = ((cb?: (err?: unknown) => void) => {\n      if (cb) cb();\n      return req.session;\n    }) as typeof req.session.save;\n  }\n  next();\n}\n\n/**\n * Routes for analytics events\n * Handles client-side analytics tracking\n */\nconst analyticsRoutes = (router: Router) => {\n  router.use('/api/analytics', skipSessionSave);\n\n  /**\n   * POST endpoint for logging link clicks (both internal and external)\n   * Called by client-side JavaScript when a user clicks a link\n   */\n  router.post('/api/analytics/link-click', (request, response) => {\n    const { url, linkText, linkType, currentPage } = request.body;\n\n    // Validate that we have the required data\n    if (!url || typeof url !== 'string') {\n      return response.status(400).json({ error: 'Invalid request: url is required' });\n    }\n\n    // Log the link click event\n    logLinkClick(request, url, linkText, linkType, currentPage);\n\n    // Return success response\n    response.status(204).send();\n  });\n\n  /**\n   * POST endpoint for logging page exits\n   * Called by client-side JavaScript when a user closes tab/window or navigates away\n   */\n  router.post('/api/analytics/page-exit', (request, response) => {\n    const { exitPage, destinationUrl } = request.body;\n\n    // Validate that we have the required data\n    if (!exitPage || typeof exitPage !== 'string') {\n      return response.status(400).json({ error: 'Invalid request: exitPage is required' });\n    }\n\n    // Log the page exit event\n    logPageExit(request, exitPage, destinationUrl);\n\n    // Return success response\n    response.status(204).send();\n  });\n\n  /**\n   * POST endpoint for logging quick exits\n   * Called by client-side JavaScript when a user clicks the quick exit button\n   */\n  router.post('/api/analytics/quick-exit', (request, response) => {\n    const { exitPage } = request.body;\n\n    // Validate that we have the required data\n    if (!exitPage || typeof exitPage !== 'string') {\n      return response.status(400).json({ error: 'Invalid request: exitPage is required' });\n    }\n\n    // Log the quick exit event\n    logQuickExit(request, exitPage);\n\n    // Return success response\n    response.status(204).send();\n  });\n};\n\nexport default analyticsRoutes;\n"],
  "mappings": ";;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAEA,8BAAwD;AASxD,SAAS,gBAAgB,KAAc,MAAgB,MAAoB;AACzE,MAAI,IAAI,SAAS;AACf,QAAI,QAAQ,OAAQ,CAAC,OAAiC;AACpD,UAAI,GAAI,IAAG;AACX,aAAO,IAAI;AAAA,IACb;AAAA,EACF;AACA,OAAK;AACP;AAMA,MAAM,kBAAkB,CAAC,WAAmB;AAC1C,SAAO,IAAI,kBAAkB,eAAe;AAM5C,SAAO,KAAK,6BAA6B,CAAC,SAAS,aAAa;AAC9D,UAAM,EAAE,KAAK,UAAU,UAAU,YAAY,IAAI,QAAQ;AAGzD,QAAI,CAAC,OAAO,OAAO,QAAQ,UAAU;AACnC,aAAO,SAAS,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mCAAmC,CAAC;AAAA,IAChF;AAGA,8CAAa,SAAS,KAAK,UAAU,UAAU,WAAW;AAG1D,aAAS,OAAO,GAAG,EAAE,KAAK;AAAA,EAC5B,CAAC;AAMD,SAAO,KAAK,4BAA4B,CAAC,SAAS,aAAa;AAC7D,UAAM,EAAE,UAAU,eAAe,IAAI,QAAQ;AAG7C,QAAI,CAAC,YAAY,OAAO,aAAa,UAAU;AAC7C,aAAO,SAAS,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wCAAwC,CAAC;AAAA,IACrF;AAGA,6CAAY,SAAS,UAAU,cAAc;AAG7C,aAAS,OAAO,GAAG,EAAE,KAAK;AAAA,EAC5B,CAAC;AAMD,SAAO,KAAK,6BAA6B,CAAC,SAAS,aAAa;AAC9D,UAAM,EAAE,SAAS,IAAI,QAAQ;AAG7B,QAAI,CAAC,YAAY,OAAO,aAAa,UAAU;AAC7C,aAAO,SAAS,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wCAAwC,CAAC;AAAA,IACrF;AAGA,8CAAa,SAAS,QAAQ;AAG9B,aAAS,OAAO,GAAG,EAAE,KAAK;AAAA,EAC5B,CAAC;AACH;AAEA,IAAO,oBAAQ;",
  "names": []
}
