{
  "version": 3,
  "sources": ["../../../server/routes/specialDays/whatWillHappen.ts"],
  "sourcesContent": ["import { Router } from 'express';\nimport { body, validationResult } from 'express-validator';\n\nimport { WhatWillHappenAnswer } from '../../@types/session';\nimport formFields from '../../constants/formFields';\nimport FORM_STEPS from '../../constants/formSteps';\nimport paths from '../../constants/paths';\nimport checkFormProgressFromConfig  from '../../middleware/checkFormProgressFromConfig';\nimport addCompletedStep from '../../utils/addCompletedStep';\nimport { isDesign2, isDesign3, isDesign4, isPerChildPoCEnabled, getSessionValue, setSessionSection } from '../../utils/perChildSession';\nimport { getBackUrl, getRedirectUrlAfterFormSubmit } from '../../utils/sessionHelpers';\n\n// Helper to get the field name for a specific child index\nconst getFieldName = (childIndex: number) => `${formFields.SPECIAL_DAYS}-${childIndex}`;\n\n// Helper to get the child selector field name for a specific entry index\nconst _getChildSelectorFieldName = (entryIndex: number) => `child-selector-${entryIndex}`;\n\n// Helper to safely get a trimmed string from request body\nconst safeString = (value: unknown): string => {\n  if (typeof value === 'string') {\n    return value.trim();\n  }\n  return '';\n};\n\nconst whatWillHappenRoutes = (router: Router) => {\n  router.get(paths.SPECIAL_DAYS_WHAT_WILL_HAPPEN, checkFormProgressFromConfig(FORM_STEPS.SPECIAL_DAYS_WHAT_WILL_HAPPEN), (request, response) => {\n    const { numberOfChildren, namesOfChildren, specialDays } = request.session;\n    const isD2 = isDesign2(request.session);\n    const activeChildIndex = isD2 ? (request.session.currentChildIndex ?? 0) : 0;\n    const activeChildName = isD2 ? namesOfChildren[activeChildIndex] : null;\n    const sessionSpecialDays = isD2 ? getSessionValue<any>(request.session, 'specialDays') as typeof specialDays : specialDays;\n    const existingAnswers = sessionSpecialDays?.whatWillHappen;\n\n    // Build form values from existing session data\n    const formValues: Record<string, string> = {};\n\n    // Track which children have specific answers\n    const childrenWithAnswers: number[] = [];\n\n    if (existingAnswers) {\n      // Set the default answer (shown as \"all children\" or first entry)\n      if (existingAnswers.default?.answer) {\n        formValues[getFieldName(0)] = existingAnswers.default.answer;\n      }\n\n      // Set per-child answers\n      if (existingAnswers.byChild) {\n        Object.entries(existingAnswers.byChild).forEach(([childIndex, answer]) => {\n          const idx = parseInt(childIndex, 10);\n          if (answer.answer) {\n            childrenWithAnswers.push(idx);\n            formValues[getFieldName(idx)] = answer.answer;\n          }\n        });\n      }\n    }\n\n    // Build list of children for dropdown options\n    const childOptions = namesOfChildren.map((name, index) => ({\n      value: index.toString(),\n      text: name,\n    }));\n\n    response.render('pages/specialDays/whatWillHappen', {\n      errors: request.flash('errors'),\n      formValues: { ...formValues, ...request.flash('formValues')?.[0] },\n      title: isD2 ? `What will happen for ${activeChildName} on special days?` : request.__('specialDays.whatWillHappen.title'),\n      backLinkHref: getBackUrl(request.session, paths.TASK_LIST),\n      numberOfChildren,\n      namesOfChildren,\n      childOptions,\n      childrenWithAnswers,\n      childProgressCaption: isD2 ? `Child ${activeChildIndex + 1} of ${numberOfChildren}` : null,\n      showPerChildOption: numberOfChildren > 1 && !isDesign3(request.session) && isPerChildPoCEnabled(request.session),\n      showDesign3Option: numberOfChildren > 1 && isDesign3(request.session) && isPerChildPoCEnabled(request.session),\n      designMode: request.session.perChildDesignMode || 'design1',\n    });\n  });\n\n  router.post(\n    paths.SPECIAL_DAYS_WHAT_WILL_HAPPEN,\n    (request, response, next) => {\n      const { numberOfChildren } = request.session;\n\n      // Dynamic validation based on submitted fields\n      const validations: ReturnType<typeof body>[] = [];\n\n      // Always validate the default/first answer\n      validations.push(\n        body(getFieldName(0))\n          .trim()\n          .notEmpty()\n          .withMessage((_value, { req }) => req.__('specialDays.whatWillHappen.error'))\n      );\n\n      // Check for per-child entries and validate them\n      for (let i = 1; i <= numberOfChildren; i++) {\n        const fieldName = getFieldName(i);\n        // Only validate if the field exists in the request\n        if (request.body[fieldName] !== undefined && request.body[fieldName] !== '') {\n          validations.push(\n            body(fieldName)\n              .trim()\n              .notEmpty()\n              .withMessage((_value, { req }) => req.__('specialDays.whatWillHappen.error'))\n          );\n        }\n      }\n\n      // Run all validations\n      Promise.all(validations.map(validation => validation.run(request)))\n        .then(() => next())\n        .catch(next);\n    },\n    (request, response) => {\n      // Design 3: handle \"specify per child\" - switch to per-child (Design 2) mode\n      if (isDesign3(request.session) && request.body['specify-per-child'] === 'yes') {\n        request.session.perChildDesignMode = 'design2' as any;\n        request.session.currentChildIndex = 0;\n        if (!request.session.childPlans || request.session.childPlans.length === 0) {\n          request.session.childPlans = (request.session.namesOfChildren || []).map((name: string, index: number) => ({\n            childIndex: index,\n            childName: name,\n            isComplete: false,\n          }));\n        }\n        return response.redirect(paths.SPECIAL_DAYS_WHAT_WILL_HAPPEN);\n      }\n\n      const errors = validationResult(request);\n\n      if (!errors.isEmpty()) {\n        request.flash('errors', errors.array());\n        request.flash('formValues', request.body);\n        return response.redirect(paths.SPECIAL_DAYS_WHAT_WILL_HAPPEN);\n      }\n\n      // Process the default answer\n      const defaultAnswer = safeString(request.body[getFieldName(0)]);\n\n      // Build the per-child answers structure\n      const byChild: Record<number, WhatWillHappenAnswer> = {};\n\n      // Check for additional per-child entries\n      // We look for patterns like child-selector-1, child-selector-2, etc.\n      // and their corresponding answer fields\n      let additionalEntries: Array<{childIndex: number, answer: string, entryIndex: number}>;\n\n      if (isDesign4(request.session)) {\n        // Design 4: checkboxes can select multiple children per entry\n        additionalEntries = Object.keys(request.body)\n          .filter(key => /^child-checkbox-\\d+$/.test(key))\n          .flatMap(key => {\n            const entryIndex = parseInt(key.replace('child-checkbox-', ''), 10);\n            const rawValues = request.body[key];\n            const childIndices = (Array.isArray(rawValues) ? rawValues : [rawValues])\n              .map((v: string) => parseInt(v, 10))\n              .filter((v: number) => !isNaN(v));\n            const answerFieldName = getFieldName(entryIndex);\n            const answer = safeString(request.body[answerFieldName]);\n            return childIndices.map(childIndex => ({ childIndex, answer, entryIndex }));\n          })\n          .filter(entry => entry.answer);\n      } else {\n        // Design 1: SELECT dropdown with single child\n        additionalEntries = Object.keys(request.body)\n          .filter(key => key.startsWith('child-selector-'))\n          .map(key => {\n            const entryIndex = parseInt(key.replace('child-selector-', ''), 10);\n            const childIndex = parseInt(request.body[key], 10);\n            const answerFieldName = getFieldName(entryIndex);\n            const answer = safeString(request.body[answerFieldName]);\n            return { childIndex, answer, entryIndex };\n          })\n          .filter(entry => !isNaN(entry.childIndex) && entry.answer);\n      }\n\n      // Store per-child answers\n      additionalEntries.forEach(entry => {\n        byChild[entry.childIndex] = {\n          noDecisionRequired: false,\n          answer: entry.answer,\n        };\n      });\n\n      const { numberOfChildren } = request.session;\n\n      const newWhatWillHappen = {\n        default: {\n          noDecisionRequired: false,\n          answer: defaultAnswer,\n        },\n        ...(Object.keys(byChild).length > 0 ? { byChild } : {}),\n      };\n\n      if (isDesign2(request.session)) {\n        const currentSpecialDays = getSessionValue<any>(request.session, 'specialDays') || {};\n        setSessionSection(request.session, 'specialDays', { ...currentSpecialDays, whatWillHappen: newWhatWillHappen });\n      } else {\n        request.session.specialDays = {\n          ...request.session.specialDays,\n          whatWillHappen: newWhatWillHappen,\n        };\n      }\n\n      addCompletedStep(request, FORM_STEPS.SPECIAL_DAYS_WHAT_WILL_HAPPEN);\n\n      if (isDesign2(request.session)) {\n        if (request.body['apply-to-all'] === 'yes') {\n          const savedIndex = request.session.currentChildIndex ?? 0;\n          for (let i = 0; i < numberOfChildren; i++) {\n            if (i !== savedIndex) {\n              request.session.currentChildIndex = i;\n              const childSpecialDays = getSessionValue<any>(request.session, 'specialDays') || {};\n              setSessionSection(request.session, 'specialDays', { ...childSpecialDays, whatWillHappen: newWhatWillHappen });\n            }\n          }\n          request.session.currentChildIndex = 0;\n          return response.redirect(paths.TASK_LIST);\n        }\n        const nextChildIndex = (request.session.currentChildIndex ?? 0) + 1;\n        if (nextChildIndex < numberOfChildren) {\n          request.session.currentChildIndex = nextChildIndex;\n          return response.redirect(paths.SPECIAL_DAYS_WHAT_WILL_HAPPEN);\n        }\n        request.session.currentChildIndex = 0;\n        return response.redirect(paths.TASK_LIST);\n      }\n\n      return response.redirect(getRedirectUrlAfterFormSubmit(request.session, paths.TASK_LIST));\n    },\n  );\n\n  router.post(paths.SPECIAL_DAYS_WHAT_WILL_HAPPEN_NOT_REQUIRED, (request, response) => {\n    request.session.specialDays = {\n      ...request.session.specialDays,\n      whatWillHappen: {\n        default: {\n          noDecisionRequired: true,\n        },\n      },\n    };\n\n    addCompletedStep(request, FORM_STEPS.SPECIAL_DAYS_WHAT_WILL_HAPPEN);\n\n    return response.redirect(getRedirectUrlAfterFormSubmit(request.session, paths.TASK_LIST));\n  });\n};\n\nexport default whatWillHappenRoutes;\n"],
  "mappings": "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",
  "names": ["formFields", "paths", "checkFormProgressFromConfig", "FORM_STEPS", "addCompletedStep"]
}
